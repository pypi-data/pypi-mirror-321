# automatically generated by auxilium
{% include 'base_arg.jinja2' -%}
FROM {{ opts.base | default(aux.project.slug~"-python-deps", true) }} as base
# uses python{{ opts.version }}
{% include 'apt_install_root.jinja2' -%}
{% include 'extra_script.jinja2' -%}

FROM base AS build
USER root:root
RUN apt-get update && apt-get install -y \
    build-essential \
    --no-install-recommends && apt-get clean && rm -rf /var/lib/apt/lists/*

USER container:container
WORKDIR /home/container

{% include 'pip_install.jinja2' -%}

RUN git init
COPY devops/pre-commit/config.yaml .pre-commit-config.yaml
RUN pre-commit install-hooks

FROM base as final

USER container:container
WORKDIR /home/container

{% if aux.pip.use_uv -%}
COPY --chown=container --from=build /home/container/.venv/bin/ .venv/bin/
COPY --chown=container --from=build /home/container/.venv/lib/ .venv/lib/
{% endif -%}
COPY --chown=container --from=build /home/container/.local/bin/ .local/bin/
COPY --chown=container --from=build /home/container/.local/lib/ .local/lib/
COPY --chown=container --from=build /home/container/.local/share/ .local/share/
COPY --chown=container --from=build /home/container/.cache/pre-commit/ .cache/pre-commit/

ENV PYTHONPATH='{{ aux.project.get("source_dir", "source") }}'
RUN git config --global --add safe.directory /home/container/workdir
CMD ["pre-commit", "run"]
{% block custom %}{% endblock %}
