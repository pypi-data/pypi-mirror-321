function C(s,e,t,n){function r(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function c(b){try{u(n.next(b))}catch(y){o(y)}}function a(b){try{u(n.throw(b))}catch(y){o(y)}}function u(b){b.done?i(b.value):r(b.value).then(c,a)}u((n=n.apply(s,[])).next())})}function Q(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var D={exports:{}},S=typeof Reflect=="object"?Reflect:null,U=S&&typeof S.apply=="function"?S.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)},P;S&&typeof S.ownKeys=="function"?P=S.ownKeys:Object.getOwnPropertySymbols?P=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:P=function(s){return Object.getOwnPropertyNames(s)};function X(s){console&&console.warn&&console.warn(s)}var N=Number.isNaN||function(s){return s!==s};function h(){h.init.call(this)}D.exports=h;D.exports.once=ee;h.EventEmitter=h;h.prototype._events=void 0;h.prototype._eventsCount=0;h.prototype._maxListeners=void 0;var z=10;function L(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(h,"defaultMaxListeners",{enumerable:!0,get:function(){return z},set:function(s){if(typeof s!="number"||s<0||N(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");z=s}});h.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};h.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||N(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function W(s){return s._maxListeners===void 0?h.defaultMaxListeners:s._maxListeners}h.prototype.getMaxListeners=function(){return W(this)};h.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var n=s==="error",r=this._events;if(r!==void 0)n=n&&r.error===void 0;else if(!n)return!1;if(n){var i;if(e.length>0&&(i=e[0]),i instanceof Error)throw i;var o=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw o.context=i,o}var c=r[s];if(c===void 0)return!1;if(typeof c=="function")U(c,this,e);else for(var a=c.length,u=V(c,a),t=0;t<a;++t)U(u[t],this,e);return!0};function J(s,e,t,n){var r,i,o;if(L(t),i=s._events,i===void 0?(i=s._events=Object.create(null),s._eventsCount=0):(i.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),i=s._events),o=i[e]),o===void 0)o=i[e]=t,++s._eventsCount;else if(typeof o=="function"?o=i[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),r=W(s),r>0&&o.length>r&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=s,c.type=e,c.count=o.length,X(c)}return s}h.prototype.addListener=function(s,e){return J(this,s,e,!1)};h.prototype.on=h.prototype.addListener;h.prototype.prependListener=function(s,e){return J(this,s,e,!0)};function Y(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function B(s,e,t){var n={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},r=Y.bind(n);return r.listener=t,n.wrapFn=r,r}h.prototype.once=function(s,e){return L(e),this.on(s,B(this,s,e)),this};h.prototype.prependOnceListener=function(s,e){return L(e),this.prependListener(s,B(this,s,e)),this};h.prototype.removeListener=function(s,e){var t,n,r,i,o;if(L(e),n=this._events,n===void 0)return this;if(t=n[s],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete n[s],n.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(r=-1,i=t.length-1;i>=0;i--)if(t[i]===e||t[i].listener===e){o=t[i].listener,r=i;break}if(r<0)return this;r===0?t.shift():Z(t,r),t.length===1&&(n[s]=t[0]),n.removeListener!==void 0&&this.emit("removeListener",s,o||e)}return this};h.prototype.off=h.prototype.removeListener;h.prototype.removeAllListeners=function(s){var e,t,n;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var r=Object.keys(t),i;for(n=0;n<r.length;++n)i=r[n],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[s],typeof e=="function")this.removeListener(s,e);else if(e!==void 0)for(n=e.length-1;n>=0;n--)this.removeListener(s,e[n]);return this};function q(s,e,t){var n=s._events;if(n===void 0)return[];var r=n[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?$(r):V(r,r.length)}h.prototype.listeners=function(s){return q(this,s,!0)};h.prototype.rawListeners=function(s){return q(this,s,!1)};h.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):F.call(s,e)};h.prototype.listenerCount=F;function F(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}h.prototype.eventNames=function(){return this._eventsCount>0?P(this._events):[]};function V(s,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=s[n];return t}function Z(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function $(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function ee(s,e){return new Promise(function(t,n){function r(o){s.removeListener(e,i),n(o)}function i(){typeof s.removeListener=="function"&&s.removeListener("error",r),t([].slice.call(arguments))}H(s,e,i,{once:!0}),e!=="error"&&te(s,r,{once:!0})})}function te(s,e,t){typeof s.on=="function"&&H(s,"error",e,t)}function H(s,e,t,n){if(typeof s.on=="function")n.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function r(i){n.once&&s.removeEventListener(e,r),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var ne=D.exports,K=Q(ne),_;(function(s){s[s.timeout=1]="timeout",s[s.transportClosed=2]="transportClosed",s[s.clientDisconnected=3]="clientDisconnected",s[s.clientClosed=4]="clientClosed",s[s.clientConnectToken=5]="clientConnectToken",s[s.clientRefreshToken=6]="clientRefreshToken",s[s.subscriptionUnsubscribed=7]="subscriptionUnsubscribed",s[s.subscriptionSubscribeToken=8]="subscriptionSubscribeToken",s[s.subscriptionRefreshToken=9]="subscriptionRefreshToken",s[s.transportWriteError=10]="transportWriteError",s[s.connectionClosed=11]="connectionClosed",s[s.badConfiguration=12]="badConfiguration"})(_||(_={}));var w;(function(s){s[s.connectCalled=0]="connectCalled",s[s.transportClosed=1]="transportClosed",s[s.noPing=2]="noPing",s[s.subscribeTimeout=3]="subscribeTimeout",s[s.unsubscribeError=4]="unsubscribeError"})(w||(w={}));var k;(function(s){s[s.disconnectCalled=0]="disconnectCalled",s[s.unauthorized=1]="unauthorized",s[s.badProtocol=2]="badProtocol",s[s.messageSizeLimit=3]="messageSizeLimit"})(k||(k={}));var x;(function(s){s[s.subscribeCalled=0]="subscribeCalled",s[s.transportClosed=1]="transportClosed"})(x||(x={}));var R;(function(s){s[s.unsubscribeCalled=0]="unsubscribeCalled",s[s.unauthorized=1]="unauthorized",s[s.clientClosed=2]="clientClosed"})(R||(R={}));var p;(function(s){s.Disconnected="disconnected",s.Connecting="connecting",s.Connected="connected"})(p||(p={}));var m;(function(s){s.Unsubscribed="unsubscribed",s.Subscribing="subscribing",s.Subscribed="subscribed"})(m||(m={}));function se(s,e){return s.lastIndexOf(e,0)===0}function G(s){return s==null?!1:typeof s=="function"}function re(s,e){if(globalThis.console){const t=globalThis.console[s];G(t)&&t.apply(globalThis.console,e)}}function ie(s,e){return Math.floor(Math.random()*(e-s+1)+s)}function O(s,e,t){s>31&&(s=31);const n=ie(0,Math.min(t,e*Math.pow(2,s)));return Math.min(t,e+n)}function oe(s){return"error"in s&&s.error!==null}function j(s){return Math.min(s*1e3,2147483647)}class ce extends K{constructor(e,t,n){super(),this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state=m.Unsubscribed,this._centrifuge=e,this._token="",this._getToken=null,this._data=null,this._getData=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._delta="",this._delta_negotiated=!1,this._prevValue=null,this._unsubPromise=Promise.resolve(),this._setOptions(n),this._centrifuge._debugEnabled?(this.on("state",r=>{this._centrifuge._debug("subscription state",t,r.oldState,"->",r.newState)}),this.on("error",r=>{this._centrifuge._debug("subscription error",t,r)})):this.on("error",function(){Function.prototype()})}ready(e){return this.state===m.Unsubscribed?Promise.reject({code:_.subscriptionUnsubscribed,message:this.state}):this.state===m.Subscribed?Promise.resolve():new Promise((t,n)=>{const r={resolve:t,reject:n};e&&(r.timeout=setTimeout(function(){n({code:_.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=r})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(x.subscribeCalled,"subscribe called"))}unsubscribe(){this._unsubPromise=this._setUnsubscribed(R.unsubscribeCalled,"unsubscribe called",!0)}publish(e){const t=this;return this._methodCall().then(function(){return t._centrifuge.publish(t.channel,e)})}presence(){const e=this;return this._methodCall().then(function(){return e._centrifuge.presence(e.channel)})}presenceStats(){const e=this;return this._methodCall().then(function(){return e._centrifuge.presenceStats(e.channel)})}history(e){const t=this;return this._methodCall().then(function(){return t._centrifuge.history(t.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:_.subscriptionUnsubscribed,message:this.state}):new Promise((e,t)=>{const n=setTimeout(function(){t({code:_.timeout,message:"timeout"})},this._centrifuge._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return this._recover===!0}_isUnsubscribed(){return this.state===m.Unsubscribed}_isSubscribing(){return this.state===m.Subscribing}_isSubscribed(){return this.state===m.Subscribed}_setState(e){if(this.state!==e){const t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0}return!1}_usesToken(){return this._token!==""||this._getToken!==null}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),e.delta?this._delta_negotiated=!0:this._delta_negotiated=!1,this._setState(m.Subscribed);const t=this._centrifuge._getSubscribeContext(this.channel,e);this.emit("subscribed",t),this._resolvePromises();const n=e.publications;if(n&&n.length>0)for(const r in n)n.hasOwnProperty(r)&&this._handlePublication(n[r]);e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),j(e.ttl)))}_setSubscribing(e,t){return C(this,void 0,void 0,function*(){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState(m.Subscribing)&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._centrifuge._transport&&this._centrifuge._transport.emulation()&&(yield this._unsubPromise),this._isSubscribing()&&this._subscribe())})}_subscribe(){if(this._centrifuge._debug("subscribing on",this.channel),!this._centrifuge._transportIsOpen)return this._centrifuge._debug("delay subscribe on",this.channel,"till connected"),null;const e=this,t={channel:e.channel};return!this._usesToken()||this._token?e._getData?(e._getData(t).then(function(n){e._isSubscribing()&&(e._data=n,e._sendSubscribe(e._token))}),null):e._sendSubscribe(e._token):(this._getSubscriptionToken().then(function(n){if(e._isSubscribing()){if(!n){e._failUnauthorized();return}e._token=n,e._getData?e._getData(t).then(function(r){e._isSubscribing()&&(e._data=r,e._sendSubscribe(n))}):e._sendSubscribe(n)}}).catch(function(n){if(e._isSubscribing()){if(n instanceof T){e._failUnauthorized();return}e.emit("error",{type:"subscribeToken",channel:e.channel,error:{code:_.subscriptionSubscribeToken,message:n!==void 0?n.toString():""}}),e._scheduleResubscribe()}}),null)}_sendSubscribe(e){if(!this._centrifuge._transportIsOpen)return null;const t={channel:this.channel};if(e&&(t.token=e),this._data&&(t.data=this._data),this._positioned&&(t.positioned=!0),this._recoverable&&(t.recoverable=!0),this._joinLeave&&(t.join_leave=!0),this._needRecover()){t.recover=!0;const r=this._getOffset();r&&(t.offset=r);const i=this._getEpoch();i&&(t.epoch=i)}this._delta&&(t.delta=this._delta);const n={subscribe:t};return this._inflight=!0,this._centrifuge._call(n).then(r=>{this._inflight=!1;const i=r.reply.subscribe;this._handleSubscribeResponse(i),r.next&&r.next()},r=>{this._inflight=!1,this._handleSubscribeError(r.error),r.next&&r.next()}),n}_handleSubscribeError(e){if(this._isSubscribing()){if(e.code===_.timeout){this._centrifuge._disconnect(w.subscribeTimeout,"subscribe timeout",!0);return}this._subscribeError(e)}}_handleSubscribeResponse(e){this._isSubscribing()&&this._setSubscribed(e)}_setUnsubscribed(e,t,n){if(this._isUnsubscribed())return Promise.resolve();let r=Promise.resolve();return this._isSubscribed()?(n&&(r=this._centrifuge._unsubscribe(this)),this._clearSubscribedState()):this._isSubscribing()&&(this._inflight&&n&&(r=this._centrifuge._unsubscribe(this)),this._clearSubscribingState()),this._setState(m.Unsubscribed)&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:_.subscriptionUnsubscribed,message:this.state}),r}_handlePublication(e){if(this._delta&&this._delta_negotiated){const{newData:n,newPrevValue:r}=this._centrifuge._codec.applyDeltaIfNeeded(e,this._prevValue);e.data=n,this._prevValue=r}const t=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){const t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:t})}_handleLeave(e){const t=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:t})}_resolvePromises(){for(const e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(const t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}_scheduleResubscribe(){const e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe()},t)}_subscribeError(e){if(this._isSubscribing())if(e.code<100||e.code===109||e.temporary===!0){e.code===109&&(this._token="");const t={channel:this.channel,type:"subscribe",error:e};this._centrifuge.state===p.Connected&&this.emit("error",t),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}_getResubscribeDelay(){const e=O(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){if(e&&(e.since&&(this._offset=e.since.offset,this._epoch=e.since.epoch,this._recover=!0),e.data&&(this._data=e.data),e.getData&&(this._getData=e.getData),e.minResubscribeDelay!==void 0&&(this._minResubscribeDelay=e.minResubscribeDelay),e.maxResubscribeDelay!==void 0&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),e.positioned===!0&&(this._positioned=!0),e.recoverable===!0&&(this._recoverable=!0),e.joinLeave===!0&&(this._joinLeave=!0),e.delta)){if(e.delta!=="fossil")throw new Error("unsupported delta format");this._delta=e.delta}}_getOffset(){const e=this._offset;return e!==null?e:0}_getEpoch(){const e=this._epoch;return e!==null?e:""}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){this._resubscribeTimeout!==null&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._centrifuge._debug("get subscription token for channel",this.channel);const e={channel:this.channel},t=this._getToken;if(t===null)throw this.emit("error",{type:"configuration",channel:this.channel,error:{code:_.badConfiguration,message:"provide a function to get channel subscription token"}}),new T("");return t(e)}_refresh(){this._clearRefreshTimeout();const e=this;this._getSubscriptionToken().then(function(t){if(!e._isSubscribed())return;if(!t){e._failUnauthorized();return}e._token=t;const n={sub_refresh:{channel:e.channel,token:t}};e._centrifuge._call(n).then(r=>{const i=r.reply.sub_refresh;e._refreshResponse(i),r.next&&r.next()},r=>{e._refreshError(r.error),r.next&&r.next()})}).catch(function(t){if(t instanceof T){e._failUnauthorized();return}e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:_.subscriptionRefreshToken,message:t!==void 0?t.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay())})}_refreshResponse(e){this._isSubscribed()&&(this._centrifuge._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),j(e.ttl))))}_refreshError(e){this._isSubscribed()&&(e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return O(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(R.unauthorized,"unauthorized",!0)}}class ae{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return this.options.sockjs!==null}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=n=>{t.onError(n)},this._transport.onclose=n=>{t.onClose(n)},this._transport.onmessage=n=>{t.onMessage(n.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}}class A{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return this.options.websocket!==void 0&&this.options.websocket!==null}initialize(e,t){let n="";e==="protobuf"&&(n="centrifuge-protobuf"),n!==""?this._transport=new this.options.websocket(this.endpoint,n):this._transport=new this.options.websocket(this.endpoint),e==="protobuf"&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=r=>{t.onError(r)},this._transport.onclose=r=>{t.onClose(r)},this._transport.onmessage=r=>{t.onMessage(r.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}}class he{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw new Error(e.status);return e}_fetchEventTarget(e,t,n){const r=new EventTarget,i=e.options.fetch;return i(t,n).then(e._handleErrors).then(o=>{r.dispatchEvent(new Event("open"));let c="",a=0,u=new Uint8Array;const b=o.body.getReader();return new e.options.readableStream({start(y){function v(){return b.read().then(({done:l,value:g})=>{if(l){r.dispatchEvent(new Event("close")),y.close();return}try{if(e._protocol==="json")for(c+=e._utf8decoder.decode(g);a<c.length;)if(c[a]===`
`){const f=c.substring(0,a);r.dispatchEvent(new MessageEvent("message",{data:f})),c=c.substring(a+1),a=0}else++a;else{const f=new Uint8Array(u.length+g.length);for(f.set(u),f.set(g,u.length),u=f;;){const d=e.options.decoder.decodeReply(u);if(d.ok){const E=u.slice(0,d.pos);r.dispatchEvent(new MessageEvent("message",{data:E})),u=u.slice(d.pos);continue}break}}}catch(f){r.dispatchEvent(new Event("error",{detail:f})),r.dispatchEvent(new Event("close")),y.close();return}v()}).catch(function(l){r.dispatchEvent(new Event("error",{detail:l})),r.dispatchEvent(new Event("close")),y.close()})}return v()}})}).catch(o=>{r.dispatchEvent(new Event("error",{detail:o})),r.dispatchEvent(new Event("close"))}),r}supported(){return this.options.fetch!==null&&this.options.readableStream!==null&&typeof TextDecoder<"u"&&typeof AbortController<"u"&&typeof EventTarget<"u"&&typeof Event<"u"&&typeof MessageEvent<"u"&&typeof Error<"u"}initialize(e,t,n){this._protocol=e,this._abortController=new AbortController;let r,i;e==="json"?(r={Accept:"application/json","Content-Type":"application/json"},i=n):(r={Accept:"application/octet-stream","Content-Type":"application/octet-stream"},i=n);const o={method:"POST",headers:r,body:i,mode:"cors",credentials:"same-origin",cache:"no-cache",signal:this._abortController.signal},c=this._fetchEventTarget(this,this.endpoint,o);c.addEventListener("open",()=>{t.onOpen()}),c.addEventListener("error",a=>{this._abortController.abort(),t.onError(a)}),c.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),c.addEventListener("message",a=>{t.onMessage(a.data)})}close(){this._abortController.abort()}send(e,t,n){let r,i;const o={session:t,node:n,data:e};this._protocol==="json"?(r={"Content-Type":"application/json"},i=JSON.stringify(o)):(r={"Content-Type":"application/octet-stream"},i=this.options.encoder.encodeEmulationRequest(o));const c=this.options.fetch,a={method:"POST",headers:r,body:i,mode:"cors",credentials:"same-origin",cache:"no-cache"};c(this.options.emulationEndpoint,a)}}class ue{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return this.options.eventsource!==null&&this.options.fetch!==null}initialize(e,t,n){let r;globalThis&&globalThis.document&&globalThis.document.baseURI?r=new URL(this.endpoint,globalThis.document.baseURI):r=new URL(this.endpoint),r.searchParams.append("cf_connect",n);const i={},o=new this.options.eventsource(r.toString(),i);this._transport=o;const c=this;o.onopen=function(){t.onOpen()},o.onerror=function(a){o.close(),t.onError(a),t.onClose({code:4,reason:"connection closed"})},o.onmessage=function(a){t.onMessage(a.data)},c._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),this._onClose!==null&&this._onClose()}send(e,t,n){const r={session:t,node:n,data:e},i={"Content-Type":"application/json"},o=JSON.stringify(r),c=this.options.fetch,a={method:"POST",headers:i,body:o,mode:"cors",credentials:"same-origin",cache:"no-cache"};c(this.options.emulationEndpoint,a)}}class le{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return this.options.webtransport!==void 0&&this.options.webtransport!==null}initialize(e,t){return C(this,void 0,void 0,function*(){let n;globalThis&&globalThis.document&&globalThis.document.baseURI?n=new URL(this.endpoint,globalThis.document.baseURI):n=new URL(this.endpoint),e==="protobuf"&&n.searchParams.append("cf_protocol","protobuf"),this._protocol=e;const r=new EventTarget;this._transport=new this.options.webtransport(n.toString()),this._transport.closed.then(()=>{t.onClose({code:4,reason:"connection closed"})}).catch(()=>{t.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch{this.close();return}let i;try{i=yield this._transport.createBidirectionalStream()}catch{this.close();return}this._stream=i,this._writer=this._stream.writable.getWriter(),r.addEventListener("close",()=>{t.onClose({code:4,reason:"connection closed"})}),r.addEventListener("message",o=>{t.onMessage(o.data)}),this._startReading(r),t.onOpen()})}_startReading(e){return C(this,void 0,void 0,function*(){const t=this._stream.readable.getReader();let n="",r=0,i=new Uint8Array;try{for(;;){const{done:o,value:c}=yield t.read();if(c.length>0)if(this._protocol==="json")for(n+=this._utf8decoder.decode(c);r<n.length;)if(n[r]===`
`){const a=n.substring(0,r);e.dispatchEvent(new MessageEvent("message",{data:a})),n=n.substring(r+1),r=0}else++r;else{const a=new Uint8Array(i.length+c.length);for(a.set(i),a.set(c,i.length),i=a;;){const u=this.options.decoder.decodeReply(i);if(u.ok){const b=i.slice(0,u.pos);e.dispatchEvent(new MessageEvent("message",{data:b})),i=i.slice(u.pos);continue}break}}if(o)break}}catch{e.dispatchEvent(new Event("close"))}})}close(){return C(this,void 0,void 0,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch{}})}send(e){return C(this,void 0,void 0,function*(){let t;this._protocol==="json"?t=new TextEncoder().encode(e+`
`):t=e;try{yield this._writer.write(t)}catch{this.close()}})}}const _e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,-1,-1,-1,-1,36,-1,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,-1,-1,-1,63,-1];class de{constructor(e){this.a=e,this.pos=0}haveBytes(){return this.pos<this.a.length}getByte(){const e=this.a[this.pos];if(this.pos++,this.pos>this.a.length)throw new RangeError("out of bounds");return e}getChar(){return String.fromCharCode(this.getByte())}getInt(){let e=0,t;for(;this.haveBytes()&&(t=_e[127&this.getByte()])>=0;)e=(e<<6)+t;return this.pos--,e>>>0}}class pe{constructor(){this.a=[]}toByteArray(e){return Array.isArray(e)?this.a:new Uint8Array(this.a)}putArray(e,t,n){for(let r=t;r<n;r++)this.a.push(e[r])}}function fe(s){let e=0,t=0,n=0,r=0,i=0,o=s.length;for(;o>=16;)e=e+s[i+0]|0,t=t+s[i+1]|0,n=n+s[i+2]|0,r=r+s[i+3]|0,e=e+s[i+4]|0,t=t+s[i+5]|0,n=n+s[i+6]|0,r=r+s[i+7]|0,e=e+s[i+8]|0,t=t+s[i+9]|0,n=n+s[i+10]|0,r=r+s[i+11]|0,e=e+s[i+12]|0,t=t+s[i+13]|0,n=n+s[i+14]|0,r=r+s[i+15]|0,i+=16,o-=16;for(;o>=4;)e=e+s[i+0]|0,t=t+s[i+1]|0,n=n+s[i+2]|0,r=r+s[i+3]|0,i+=4,o-=4;switch(r=((r+(n<<8)|0)+(t<<16)|0)+(e<<24)|0,o){case 3:r=r+(s[i+2]<<8)|0;case 2:r=r+(s[i+1]<<16)|0;case 1:r=r+(s[i+0]<<24)|0}return r>>>0}function be(s,e){let t=0;const n=new de(e),r=s.length,i=e.length,o=n.getInt();if(n.getChar()!==`
`)throw new Error("size integer not terminated by '\\n'");const c=new pe;for(;n.haveBytes();){const a=n.getInt();let u;switch(n.getChar()){case"@":if(u=n.getInt(),n.haveBytes()&&n.getChar()!==",")throw new Error("copy command not terminated by ','");if(t+=a,t>o)throw new Error("copy exceeds output file size");if(u+a>r)throw new Error("copy extends past end of input");c.putArray(s,u,u+a);break;case":":if(t+=a,t>o)throw new Error("insert command gives an output larger than predicted");if(a>i)throw new Error("insert count exceeds size of delta");c.putArray(n.a,n.pos,n.pos+a),n.pos+=a;break;case";":{const b=c.toByteArray(s);if(a!==fe(b))throw new Error("bad checksum");if(t!==o)throw new Error("generated size does not match predicted size");return b}default:throw new Error("unknown delta operator")}}throw new Error("unterminated delta")}class M{name(){return"json"}encodeCommands(e){return e.map(t=>JSON.stringify(t)).join(`
`)}decodeReplies(e){return e.trim().split(`
`).map(t=>JSON.parse(t))}applyDeltaIfNeeded(e,t){let n,r;if(e.delta){const i=be(t,new TextEncoder().encode(e.data));n=JSON.parse(new TextDecoder().decode(i)),r=i}else n=JSON.parse(e.data),r=new TextEncoder().encode(e.data);return{newData:n,newPrevValue:r}}}const me={token:"",getToken:null,data:null,getData:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null};class T extends Error{constructor(e){super(e),this.name=this.constructor.name}}class I extends K{constructor(e,t){super(),this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state=p.Disconnected,this._transportIsOpen=!1,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportId=0,this._deviceWentOffline=!1,this._transportClosed=!0,this._codec=new M,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token="",this._data=null,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._networkEventsSet=!1,this._config=Object.assign(Object.assign({},me),t),this._configure(),this._debugEnabled?(this.on("state",n=>{this._debug("client state",n.oldState,"->",n.newState)}),this.on("error",n=>{this._debug("client error",n)})):this.on("error",function(){Function.prototype()})}newSubscription(e,t){if(this.getSubscription(e)!==null)throw new Error("Subscription to the channel "+e+" already exists");const n=new ce(this,e,t);return this._subs[e]=n,n}getSubscription(e){return this._getSub(e)}removeSubscription(e){e&&(e.state!==m.Unsubscribed&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){return this.state===p.Disconnected?Promise.reject({code:_.clientDisconnected,message:"client disconnected"}):this.state===p.Connected?Promise.resolve():new Promise((t,n)=>{const r={resolve:t,reject:n};e&&(r.timeout=setTimeout(function(){n({code:_.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=r})}connect(){if(this._isConnected()){this._debug("connect called when already connected");return}if(this._isConnecting()){this._debug("connect called when already connecting");return}this._debug("connect called"),this._reconnectAttempts=0,this._startConnecting()}disconnect(){this._disconnect(k.disconnectCalled,"disconnect called",!1)}setToken(e){this._token=e}send(e){const t={send:{data:e}},n=this;return this._methodCall().then(function(){return n._transportSendCommands([t])?Promise.resolve():Promise.reject(n._createErrorObject(_.transportWriteError,"transport write error"))})}rpc(e,t){const n={rpc:{method:e,data:t}},r=this;return this._methodCall().then(function(){return r._callPromise(n,function(i){return{data:i.rpc.data}})})}publish(e,t){const n={publish:{channel:e,data:t}},r=this;return this._methodCall().then(function(){return r._callPromise(n,function(){return{}})})}history(e,t){const n={history:this._getHistoryRequest(e,t)},r=this;return this._methodCall().then(function(){return r._callPromise(n,function(i){const o=i.history,c=[];if(o.publications)for(let a=0;a<o.publications.length;a++)c.push(r._getPublicationContext(e,o.publications[a]));return{publications:c,epoch:o.epoch||"",offset:o.offset||0}})})}presence(e){const t={presence:{channel:e}},n=this;return this._methodCall().then(function(){return n._callPromise(t,function(r){const i=r.presence.presence;for(const o in i)if(i.hasOwnProperty(o)){const c=i[o].conn_info,a=i[o].chan_info;c&&(i[o].connInfo=c),a&&(i[o].chanInfo=a)}return{clients:i}})})}presenceStats(e){const t={presence_stats:{channel:e}},n=this;return this._methodCall().then(function(){return n._callPromise(t,function(r){const i=r.presence_stats;return{numUsers:i.num_users,numClients:i.num_clients}})})}startBatching(){this._batching=!0}stopBatching(){const e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){this._debugEnabled&&re("debug",e)}_formatOverride(){}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if(this._config.token!==null&&(this._token=this._config.token),this._config.data!==null&&(this._data=this._config.data),this._codec=new M,this._formatOverride(),(this._config.debug===!0||typeof localStorage<"u"&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),typeof this._endpoint!="string")if(typeof this._endpoint=="object"&&this._endpoint instanceof Array){this._transports=this._endpoint,this._emulation=!0;for(const e in this._transports)if(this._transports.hasOwnProperty(e)){const t=this._transports[e];if(!t.endpoint||!t.transport)throw new Error("malformed transport configuration");const n=t.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(n)<0)throw new Error("unsupported transport name: "+n)}}else throw new Error("unsupported url configuration type: only string or array of objects are supported")}_setState(e){if(this.state!==e){this._reconnecting=!1;const t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t}),!0}return!1}_isDisconnected(){return this.state===p.Disconnected}_isConnecting(){return this.state===p.Connecting}_isConnected(){return this.state===p.Connected}_nextCommandId(){return++this._commandId}_setNetworkEvents(){if(this._networkEventsSet)return;let e=null;this._config.networkEventTarget!==null?e=this._config.networkEventTarget:typeof globalThis.addEventListener<"u"&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),(this.state===p.Connected||this.state===p.Connecting)&&(this._disconnect(w.transportClosed,"transport closed",!0),this._deviceWentOffline=!0)}),e.addEventListener("online",()=>{this._debug("online event triggered"),this.state===p.Connecting&&(this._deviceWentOffline&&!this._transportClosed&&(this._deviceWentOffline=!1,this._transportClosed=!0),this._clearReconnectTimeout(),this._startReconnecting())}),this._networkEventsSet=!0)}_getReconnectDelay(){const e=O(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(const e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){const t=this._callbacks[e];clearTimeout(t.timeout);const n=t.errback;if(!n)continue;n({error:this._createErrorObject(_.connectionClosed,"connection closed")})}this._callbacks={}}_clearConnectedState(){this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout();for(const e in this._subs){if(!this._subs.hasOwnProperty(e))continue;const t=this._subs[e];t.state===m.Subscribed&&t._setSubscribing(x.transportClosed,"transport closed")}for(const e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(const t of e){const n=t.id;if(!(n in this._callbacks))continue;const r=this._callbacks[n];clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n];const i=r.errback;i({error:this._createErrorObject(_.transportWriteError,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._codec.encodeCommands(e),this._session,this._node)}catch(t){return this._debug("error writing commands",t),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e;this._config.websocket!==null?e=this._config.websocket:typeof globalThis.WebSocket!="function"&&typeof globalThis.WebSocket!="object"||(e=globalThis.WebSocket);let t=null;this._config.sockjs!==null?t=this._config.sockjs:typeof globalThis.SockJS<"u"&&(t=globalThis.SockJS);let n=null;this._config.eventsource!==null?n=this._config.eventsource:typeof globalThis.EventSource<"u"&&(n=globalThis.EventSource);let r=null;this._config.fetch!==null?r=this._config.fetch:typeof globalThis.fetch<"u"&&(r=globalThis.fetch);let i=null;if(this._config.readableStream!==null?i=this._config.readableStream:typeof globalThis.ReadableStream<"u"&&(i=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let l=0;for(;;){if(l>=this._transports.length)throw new Error("no supported transport found");const g=this._transports[this._currentTransportIndex],f=g.transport,d=g.endpoint;if(f==="websocket"){if(this._debug("trying websocket transport"),this._transport=new A(d,{websocket:e}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,l++;continue}}else if(f==="webtransport"){if(this._debug("trying webtransport transport"),this._transport=new le(d,{webtransport:globalThis.WebTransport,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,l++;continue}}else if(f==="http_stream"){if(this._debug("trying http_stream transport"),this._transport=new he(d,{fetch:r,readableStream:i,emulationEndpoint:this._config.emulationEndpoint,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,l++;continue}}else if(f==="sse"){if(this._debug("trying sse transport"),this._transport=new ue(d,{eventsource:n,fetch:r,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,l++;continue}}else if(f==="sockjs"){if(this._debug("trying sockjs"),this._transport=new ae(d,{sockjs:t,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,l++;continue}}else throw new Error("unknown transport "+f);break}}else{if(se(this._endpoint,"http"))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new A(this._endpoint,{websocket:e}),!this._transport.supported())throw new Error("WebSocket not available")}const o=this,c=this._transport,a=this._nextTransportId();o._debug("id of transport",a);let u=!1;const b=[];if(this._transport.emulation()){const l=o._sendConnect(!0);b.push(l)}this._setNetworkEvents();const y=this._codec.encodeCommands(b);this._transportClosed=!1;let v;v=setTimeout(function(){c.close()},this._config.timeout),this._transport.initialize(this._codec.name(),{onOpen:function(){if(v&&(clearTimeout(v),v=null),o._transportId!=a){o._debug("open callback from non-actual transport"),c.close();return}u=!0,o._debug(c.subName(),"transport open"),!c.emulation()&&(o._transportIsOpen=!0,o._transportWasOpen=!0,o.startBatching(),o._sendConnect(!1),o._sendSubscribeCommands(),o.stopBatching(),o.emit("__centrifuge_debug:connect_frame_sent",{}))},onError:function(l){if(o._transportId!=a){o._debug("error callback from non-actual transport");return}o._debug("transport level error",l)},onClose:function(l){if(v&&(clearTimeout(v),v=null),o._transportId!=a){o._debug("close callback from non-actual transport");return}o._debug(c.subName(),"transport closed"),o._transportClosed=!0,o._transportIsOpen=!1;let g="connection closed",f=!0,d=0;if(l&&"code"in l&&l.code&&(d=l.code),l&&l.reason)try{const E=JSON.parse(l.reason);g=E.reason,f=E.reconnect}catch{g=l.reason,(d>=3500&&d<4e3||d>=4500&&d<5e3)&&(f=!1)}d<3e3?(d===1009?(d=k.messageSizeLimit,g="message size limit exceeded",f=!1):(d=w.transportClosed,g="transport closed"),o._emulation&&!o._transportWasOpen&&(o._currentTransportIndex++,o._currentTransportIndex>=o._transports.length&&(o._triedAllTransports=!0,o._currentTransportIndex=0))):o._transportWasOpen=!0,o._isConnecting()&&!u&&o.emit("error",{type:"transport",error:{code:_.transportClosed,message:"transport closed"},transport:c.name()}),o._reconnecting=!1,o._disconnect(d,g,f)},onMessage:function(l){o._dataReceived(l)}},y),o.emit("__centrifuge_debug:transport_initialized",{})}_sendConnect(e){const t=this._constructConnectCommand(),n=this;return this._call(t,e).then(r=>{const i=r.reply.connect;n._connectResponse(i),r.next&&r.next()},r=>{n._connectError(r.error),r.next&&r.next()}),t}_startReconnecting(){if(this._debug("start reconnecting"),!this._isConnecting()){this._debug("stop reconnecting: client not in connecting state");return}if(this._reconnecting){this._debug("reconnect already in progress, return from reconnect routine");return}if(this._transportClosed===!1){this._debug("waiting for transport close");return}this._reconnecting=!0;const e=this,t=this._token==="";if(!(this._refreshRequired||t&&this._config.getToken!==null)){this._config.getData?this._config.getData().then(function(n){e._isConnecting()&&(e._data=n,e._initializeTransport())}):this._initializeTransport();return}this._getToken().then(function(n){if(e._isConnecting()){if(n==null||n==null){e._failUnauthorized();return}e._token=n,e._debug("connection token refreshed"),e._config.getData?e._config.getData().then(function(r){e._isConnecting()&&(e._data=r,e._initializeTransport())}):e._initializeTransport()}}).catch(function(n){if(!e._isConnecting())return;if(n instanceof T){e._failUnauthorized();return}e.emit("error",{type:"connectToken",error:{code:_.clientConnectToken,message:n!==void 0?n.toString():""}});const r=e._getReconnectDelay();e._debug("error on connection token refresh, reconnect after "+r+" milliseconds",n),e._reconnecting=!1,e._reconnectTimeout=setTimeout(()=>{e._startReconnecting()},r)})}_connectError(e){this.state===p.Connecting&&(e.code===109&&(this._refreshRequired=!0),e.code<100||e.temporary===!0||e.code===109?(this.emit("error",{type:"connect",error:e}),this._debug("closing transport due to connect error"),this._disconnect(e.code,e.message,!0)):this._disconnect(e.code,e.message,!1))}_scheduleReconnect(){if(!this._isConnecting())return;let e=!1;this._emulation&&!this._transportWasOpen&&!this._triedAllTransports&&(e=!0);let t=this._getReconnectDelay();e&&(t=0),this._debug("reconnect after "+t+" milliseconds"),this._clearReconnectTimeout(),this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},t)}_constructConnectCommand(){const e={};this._token&&(e.token=this._token),this._data&&(e.data=this._data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version);const t={};let n=!1;for(const r in this._serverSubs)if(this._serverSubs.hasOwnProperty(r)&&this._serverSubs[r].recoverable){n=!0;const i={recover:!0};this._serverSubs[r].offset&&(i.offset=this._serverSubs[r].offset),this._serverSubs[r].epoch&&(i.epoch=this._serverSubs[r].epoch),t[r]=i}return n&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){const n={channel:e};return t!==void 0&&(t.since&&(n.since={offset:t.since.offset},t.since.epoch&&(n.since.epoch=t.since.epoch)),t.limit!==void 0&&(n.limit=t.limit),t.reverse===!0&&(n.reverse=!0)),n}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{const n=setTimeout(function(){t({code:_.timeout,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:n,resolve:e,reject:t}})}_callPromise(e,t){return new Promise((n,r)=>{this._call(e,!1).then(i=>{n(t(i.reply)),i.next&&i.next()},i=>{r(i.error),i.next&&i.next()})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();const t=this._codec.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let n;this._dispatchPromise=new Promise(r=>{n=r}),this._dispatchSynchronized(t,n)})}_dispatchSynchronized(e,t){let n=Promise.resolve();for(const r in e)e.hasOwnProperty(r)&&(n=n.then(()=>this._dispatchReply(e[r])));n=n.then(()=>{t()})}_dispatchReply(e){let t;const n=new Promise(i=>{t=i});if(e==null)return this._debug("dispatch: got undefined or null reply"),t(),n;const r=e.id;return r&&r>0?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),n}_call(e,t){return new Promise((n,r)=>{e.id=this._nextCommandId(),this._registerCall(e.id,n,r),t||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState(p.Connecting)&&this.emit("connecting",{code:w.connectCalled,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,t,n){if(this._isDisconnected())return;this._transportIsOpen=!1;const r=this.state;this._reconnecting=!1;const i={code:e,reason:t};let o=!1;if(n?o=this._setState(p.Connecting):(o=this._setState(p.Disconnected),this._rejectPromises({code:_.clientDisconnected,message:"disconnected"})),this._clearOutgoingRequests(),r===p.Connecting&&this._clearReconnectTimeout(),r===p.Connected&&this._clearConnectedState(),o&&(this._isConnecting()?this.emit("connecting",i):this.emit("disconnected",i)),this._transport){this._debug("closing existing transport");const c=this._transport;this._transport=null,c.close(),this._transportClosed=!0,this._nextTransportId()}else this._debug("no transport to close");this._scheduleReconnect()}_failUnauthorized(){this._disconnect(k.unauthorized,"unauthorized",!1)}_getToken(){if(this._debug("get connection token"),!this._config.getToken)throw this.emit("error",{type:"configuration",error:{code:_.badConfiguration,message:"token expired but no getToken function set in the configuration"}}),new T("");return this._config.getToken({})}_refresh(){const e=this._client,t=this;this._getToken().then(function(n){if(e!==t._client)return;if(!n){t._failUnauthorized();return}if(t._token=n,t._debug("connection token refreshed"),!t._isConnected())return;const r={refresh:{token:t._token}};t._call(r,!1).then(i=>{const o=i.reply.refresh;t._refreshResponse(o),i.next&&i.next()},i=>{t._refreshError(i.error),i.next&&i.next()})}).catch(function(n){if(t._isConnected()){if(n instanceof T){t._failUnauthorized();return}t.emit("error",{type:"refreshToken",error:{code:_.clientRefreshToken,message:n!==void 0?n.toString():""}}),t._refreshTimeout=setTimeout(()=>t._refresh(),t._getRefreshRetryDelay())}})}_refreshError(e){e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return O(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),j(e.ttl)))}_removeSubscription(e){e!==null&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._transportIsOpen)return Promise.resolve();const t={unsubscribe:{channel:e.channel}},n=this;return new Promise((r,i)=>{this._call(t,!1).then(o=>{r(),o.next&&o.next()},o=>{r(),o.next&&o.next(),n._disconnect(w.unsubscribeError,"unsubscribe error",!0)})})}_getSub(e){return this._subs[e]||null}_isServerSub(e){return this._serverSubs[e]!==void 0}_sendSubscribeCommands(){const e=[];for(const t in this._subs){if(!this._subs.hasOwnProperty(t))continue;const n=this._subs[t];if(n._inflight!==!0&&n.state===m.Subscribing){const r=n._subscribe();r&&e.push(r)}}return e}_connectResponse(e){if(this._transportIsOpen=!0,this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState(p.Connected),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),j(e.ttl))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(),this.stopBatching();const t={client:e.client,transport:this._transport.subName()};e.data&&(t.data=e.data),this.emit("connected",t),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=e.ping*1e3,this._sendPong=e.pong===!0,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(const t in e){if(!e.hasOwnProperty(t))continue;const n=e[t];this._serverSubs[t]={offset:n.offset,epoch:n.epoch,recoverable:n.recoverable||!1};const r=this._getSubscribeContext(t,n);this.emit("subscribed",r)}for(const t in e){if(!e.hasOwnProperty(t))continue;const n=e[t];if(n.recovered){const r=n.publications;if(r&&r.length>0)for(const i in r)r.hasOwnProperty(i)&&this._handlePublication(t,r[i])}}for(const t in this._serverSubs)this._serverSubs.hasOwnProperty(t)&&(e[t]||(this.emit("unsubscribed",{channel:t}),delete this._serverSubs[t]))}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){this._reconnectTimeout!==null&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){this._serverPingTimeout!==null&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){this._config.maxServerPingDelay!==0&&this._isConnected()&&(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{this._isConnected()&&this._disconnect(w.noPing,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay))}_getSubscribeContext(e,t){const n={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1};t.recovered&&(n.recovered=!0),t.positioned&&(n.positioned=!0),t.recoverable&&(n.recoverable=!0),t.was_recovering&&(n.wasRecovering=!0);let r="";"epoch"in t&&(r=t.epoch);let i=0;return"offset"in t&&(i=t.offset),(n.positioned||n.recoverable)&&(n.streamPosition={offset:i,epoch:r}),t.data&&(n.data=t.data),n}_handleReply(e,t){const n=e.id;if(!(n in this._callbacks)){t();return}const r=this._callbacks[n];if(clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n],oe(e)){const i=r.errback;if(!i){t();return}const o=e.error;i({error:o,next:t})}else{const i=r.callback;if(!i)return;i({reply:e,next:t})}}_handleJoin(e,t){const n=this._getSub(e);if(!n){if(this._isServerSub(e)){const r={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("join",r)}return}n._handleJoin(t)}_handleLeave(e,t){const n=this._getSub(e);if(!n){if(this._isServerSub(e)){const r={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("leave",r)}return}n._handleLeave(t)}_handleUnsubscribe(e,t){const n=this._getSub(e);if(!n){this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}));return}t.code<2500?n._setUnsubscribed(t.code,t.reason,!1):n._setSubscribing(t.code,t.reason)}_handleSubscribe(e,t){this._serverSubs[e]={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){const t=e.code;let n=!0;(t>=3500&&t<4e3||t>=4500&&t<5e3)&&(n=!1),this._disconnect(t,e.reason,n)}_getPublicationContext(e,t){const n={channel:e,data:t.data};return t.offset&&(n.offset=t.offset),t.info&&(n.info=this._getJoinLeaveContext(t.info)),t.tags&&(n.tags=t.tags),n}_getJoinLeaveContext(e){const t={client:e.client,user:e.user};return e.conn_info&&(t.connInfo=e.conn_info),e.chan_info&&(t.chanInfo=e.chan_info),t}_handlePublication(e,t){const n=this._getSub(e);if(!n){if(this._isServerSub(e)){const r=this._getPublicationContext(e,t);this.emit("publication",r),t.offset!==void 0&&(this._serverSubs[e].offset=t.offset)}return}n._handlePublication(t)}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){if(this._sendPong){const t={};this._transportSendCommands([t])}e()}_handlePush(e,t){const n=e.channel;e.pub?this._handlePublication(n,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(n,e.join):e.leave?this._handleLeave(n,e.leave):e.unsubscribe?this._handleUnsubscribe(n,e.unsubscribe):e.subscribe?this._handleSubscribe(n,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){const e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,n){const r={code:e,message:t};return n&&(r.temporary=!0),r}_registerCall(e,t,n){this._callbacks[e]={callback:t,errback:n,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],G(n)&&n({error:this._createErrorObject(_.timeout,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_nextTransportId(){return++this._transportId}_resolvePromises(){for(const e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(const t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}}I.SubscriptionState=m;I.State=p;I.UnauthorizedError=T;export{I as Centrifuge,p as State,ce as Subscription,m as SubscriptionState,T as UnauthorizedError,w as connectingCodes,k as disconnectedCodes,_ as errorCodes,x as subscribingCodes,R as unsubscribedCodes};
