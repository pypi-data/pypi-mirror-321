{% load buttons %}
{% load i18n %}
{% load form_helpers %}

<div class=" show {% if request.GET.tab == 'source' or request.GET.tab is None %}active{% endif %}">
    <div class="row mb-3">
        <div class="col col-md-6">
          <form action="" method="get" id="appliance-type-form" class="form form-horizontal mb-3">
            <div class="panel panel-default">
            
              <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                  <strong>Nautobot Server</strong>
                  <button class="btn btn-primary mx-3 protect-btn">
                      {% trans "Save" %}
                  </button>
              </div>
              <div class="panel-body">
                {% render_form form %}
              
                <div class="form-group">
                  <div class="col-sm-3 control-label"></div>
                  <div class="col-sm-9">
                    <p>Push: Data will be pushed from Slurp'it to Nautobot</p>
                    <p>Pull: Data can be pulled from Slurp'it</p>
                    <p>Both: Pull & Push functionality are available</p>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-8 pt-3">
                    <p>
                      <b><a href="https://slurpit.io/online-courses/" target="_BLANK">Click here</a></b> to learn on how to use and configure the plugin.
                    </p>
                    <p><b>Plugin version:</b> {{ settings.PLUGINS_CONFIG.slurpit_nautobot.version }}</p>
                  </div>
                </div>
               
              </div>
            </div>
          </form>
          
          {% if appliance_type == 'both' or appliance_type == 'push'  %}
            <div class="panel panel-default">
              
              <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                  <strong>Plugin API</strong>
                  <a class="btn btn-primary mx-3" href="/user/api-tokens/" target="_blank" >
                      {% if push_api_key == '' %}
                        {% trans "Generate" %}
                      {% else %}
                        {% trans "Show" %}
                      {% endif %}
                  </a>
              </div>
              <div class="panel-body">
                <table class="table table-hover table-headings">
                  <tbody>
                    <tr>
                      <td scope="row">API Key</td>
                      <!-- <td>{{push_api_key}}</td> -->
                      <td>
                        {% if push_api_key == '' %}
                          NO API KEY
                        {% else %}
                          *******************************************
                        {% endif %}
                      </td>
                    </tr>
                  </tbody>
                </table>
                {% if debug == True %}
                  <h6>API calls:</h6>
                  <table class="table table-hover table-headings">
                    <tbody>
                      {% for item in slurpit_apis %}
                        <tr>
                          <td>
                            <span class="{% if item.type == 'DELETE' %} badge-danger{% elif item.type == 'GET' %}badge-primary{% else %}badge-success{% endif %} badge">
                              {{item.type}}
                            </span>
                          </td>
                          <td>{{ item.url}}</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                {% endif %}
                </table>
            </div>
            </div>
          {% endif %}
          <style>
            .badge-danger{
              background-color: #e01f1f;
            }
            .badge-success{
              background-color: #198754;
            }
            .badge-primary{
              background-color: #007dff;
            }
          </style>
          {% if debug == True %}
          <div class="panel panel-default" style="margin-top: 10px;">
            <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Reset Plugin</strong>
                <a class="btn btn-danger mx-3 px-3" data-toggle="modal" data-target="#resetModal">
                  {% trans "Reset" %}
                </a>
            </div>
            <div class="panel-body">
              Remove all plugin data from the Slurp'it tables.
            </div>
          </div>
          {% endif %}
          
        </div>
        <div class="col col-md-6">
          {% if appliance_type == 'both' or appliance_type == 'pull'  %}
            <div class="panel panel-default">

                <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>Slurp'it Server</strong>
                    <div>
                        <button class="btn btn-warning mx-3" data-toggle="modal" data-target="#settingsEditModal">
                            {% trans "Edit" %}
                        </button>
                        <a name="Edit" class="btn btn-primary mx-3 px-3 protect-btn" href="{% url 'plugins:slurpit_nautobot:settings' %}?test=test"> {% trans "Test" %}</a>
                    </div>
                    
                </div>
                
                <div class="panel-body">
                  <table class="table table-hover table-headings">
                    <tbody>
                      <tr class="even">
                        <td scope="row">Server URL</td>
                        <td>{{setting.server_url}}</td>
                      </tr>
                      <tr class="odd">
                        <td scope="row">API Key</td>
                        <td>{{setting.api_key}}</td>
                      </tr>
                      <tr class="even">
                        <td scope="row">Status</td>
                        <td>
                          
                          {% if connection_status == "connected" %}
                            <span class="badge bg-success" style="background-color: #198754!important;">connected</span>
                          {% elif connection_status == "" %}
                            <span></span>
                          {% else %}
                            <span class="badge bg-danger" style="background-color: #e01f1f!important;">disconnected</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr class="odd">
                        <td scope="row">Last Synced</td>
                        <td>{{setting.last_synced}}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
            </div>
          {% endif %}
        </div>

    </div>
</div>

<div class="modal fade" tabindex="-1" id="settingsEditModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button> -->
          <h4 class="modal-title">Settings</h4>
        </div>
        <form  method="post">
            {% csrf_token %}
            <div class="modal-body">
                <input type="hidden" class="form-control" name="setting_id" value="{{setting.id}}">
                <div class="form-group">
                    <label for="server_url">Server URL</label>
                    <input type="text" class="form-control" name="server_url" placeholder="Enter your Slurp'it url" value="{{setting.server_url}}">
                  </div>
                  <div class="form-group pt-2">
                    <label for="api_key">API Key</label>
                    <input type="text" class="form-control" name="api_key" placeholder="Enter your Slurp'it API key" value="{{setting.api_key}}">
                  </div>
            </div>
    
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary protect-btn" id="edit_setting_btn" >{% trans "Save" %}</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </form>
        <!-- Modal Body -->
        
      </div>
    </div>
</div>


<div class="modal fade" tabindex="-1" id="resetModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h3 class="modal-title">Are you sure to reset the Slurp'it plugin?</h3>
        <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
          <a class="btn btn-danger protect-btn" id="" href="?reset=true" >{% trans "Reset" %}</a>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>

      
    </div>
  </div>
</div>


<script>
  const projectButtons = document.querySelectorAll('.protect-btn');

  projectButtons.forEach(button => {
    button.addEventListener('click', protectButton);
  });
  function protectButton(event) {
      buttonName = event.target.textContent
      setTimeout(() => recoverButton(event, buttonName), 1500);
      event.target.classList.add('disabled');
      event.target.textContent = 'Please wait'
  }
  function recoverButton(event, buttonName) {
      event.target.classList.remove('disabled');
      event.target.textContent = buttonName
  }

</script>
