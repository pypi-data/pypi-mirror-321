{% load buttons %}
{% load i18n %}
{% load helpers %}
{% load static %}

<div class=" show {% if request.GET.tab == 'new' or request.GET.tab is None %}active{% endif %}" id="new-device-list" role="tabpanel" aria-labelledby="new-device-list-tab">
    <div class="row">
      <div class="col-sm-4 col-md-3 pull-right">
        <form method="GET" id="search-form" action="#">
            <div class="input-group">
                {{ search_form.q }}
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-primary" id="search-btn">
                        <i class="mdi mdi-magnify"></i>
                    </button>
                </span>
            </div>
        </form>
      </div>
    </div>
    <form method="post" class="form form-horizontal">
         <!-- sync button -->
        {# Object table controls #}
        {# Form buttons #}
        <div class="noprint bulk-buttons">
          <div class="bulk-button-group">
              
          </div>
        </div>
        <p id="syncStatusCaption">
        </p>
      {% csrf_token %}
      {# "Select all" form #}
      <div class="table-responsive">
        <div id="select_all_box" class="hidden panel panel-default noprint">
            <div class="panel-body">
                <div class="checkbox-inline">
                    <label for="select_all">
                        <input type="checkbox" id="select_all" name="_all" />
                        Select <strong>all {{ table.rows|length }} {{ table.data.verbose_name_plural }}</strong> matching query
                    </label>
                </div>
            </div>
        </div>
      </div>

      <div class="form form-horizontal">
        {% csrf_token %}
        <input type="hidden" name="return_url" value="{% if return_url %}{{ return_url }}{% else %}{{ request.path }}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}{% endif %}" />

        {# Object table #}

            {% if prerequisite_model %}
              {% include 'inc/missing_prerequisites.html' %}
            {% endif %}

        <div class="card">
          <div class="card-body htmx-container table-responsive" id="object_list">
            <div class="col-md-12">
              <div class="pull-left noprint">
                {% block bulk_buttons %}
                  <div class="" role="group">
  
                    {% if appliance_type == 'both' or appliance_type == 'pull'  %}
                      {% if connection_status == 'connected' %}
                        <!-- <a name="sync"  class="btn btn-orange btn-sm mx-2" href="{% url 'plugins:slurpit_nautobot:import' %}"><i class="mdi mdi-sync" aria-hidden="true"></i> {% trans "Sync" %}</a> -->
                        <button name="sync"  id="syncBtn" class="btn btn-warning mx-2 protect-btn" style="margin-right: 5px;">
                          <i class="mdi mdi-sync" aria-hidden="true"></i> 
                          <span id="syncCaption">{% trans "Sync" %}</span>
                        </button>
                      {% endif %}
                    {% endif %}
                    <button type="submit" name="_rename" formaction="{% url 'plugins:slurpit_nautobot:onboard' %}?return_url={% url 'plugins:slurpit_nautobot:slurpitimporteddevice_list' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-primary protect-btn">
                      <i class="mdi mdi-plus" aria-hidden="true"></i> {% trans "Onboard" %}
                    </button>
                    <button type="submit" name="_rename" formaction="{% url 'plugins:slurpit_nautobot:onboard' %}?remove=true&return_url={% url 'plugins:slurpit_nautobot:slurpitimporteddevice_list' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-danger ms-2 protect-btn" style="margin-left: 5px;">
                      <i class="mdi mdi-close" aria-hidden="true"></i> {% trans "Remove" %}
                    </button>
                  </div>
                {% endblock %}

                {% if bulk_edit_url and permissions.change %}
                    <button type="submit" name="_edit" formaction="{% url bulk_edit_url %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-warning btn-sm">
                        <span class="mdi mdi-pencil" aria-hidden="true"></span> Edit Selected
                    </button>
                {% endif %}
                {% if bulk_delete_url and permissions.delete %}
                    <button type="submit" name="_delete" formaction="{% url bulk_delete_url %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-danger btn-sm">
                        <span class="mdi mdi-trash-can-outline" aria-hidden="true"></span> Delete Selected
                    </button>
                {% endif %}
                
              </div>
            </div>

            {% block table %}
              {% include "slurpit_nautobot/table.html" %}
            {% endblock %}

          </div>
        </div>
      </div>

        
      </div>
    </form>
</div>

<script>
  var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

  var syncButton = document.getElementById("syncBtn");
  var syncCaptionElement = document.getElementById("syncCaption")
  var statusCaptionElement = document.getElementById("syncStatusCaption")
  var searchBtn = document.getElementById("search-btn")

  var searchForm = document.getElementById("search-form")

  var statusCaptionText = ""
  var status = ""
  var offset = 0
  const apiUrl = '/plugins/slurpit/devices/import';

  const headers = new Headers({
    'Content-Type': 'application/json',
    'X-CSRF-Token': csrfToken,
  });

  const fetchOptions = {
    method: 'GET',
    headers: headers,
  };

  if(searchBtn) {
    searchBtn.addEventListener("click", function(event) {
      searchForm.submit()
    })
  }
  if(syncButton){
    syncButton.addEventListener("click", function(event) {
      event.preventDefault();
      if(status != "") return;
      status = "Importing Devices"
      statusCaptionText = "Started to import devices from slurpit to nautobot"
      
      syncCaptionElement.innerHTML = status;
      statusCaptionElement.innerHTML = statusCaptionText;
      offset = 0;
      import_device();

    });
  }

  function import_device(flag=true) {
    var url = apiUrl+"?offset="+offset
    if(!flag) url = apiUrl

    fetch(url, fetchOptions)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      action = data["action"];

      if(action == 'error') {
        location.reload();
      }
      else if(action == "import") {
        newOffset = data["offset"];
        
        if(newOffset != offset) {
          offset = newOffset;
          statusCaptionText = "Imported "+newOffset+" devices from slurpit to nautobot"
          statusCaptionElement.innerHTML = statusCaptionText;
          import_device();
          
        }else {
          status = "Processing Devices"
          syncCaptionElement.innerHTML = status;
          import_device(false);
        }
      }else if(action == "process") {
        location.reload();
      }
      
    })
    .catch(error => {
      // console.error('Fetch error:', error);
      location.reload();
    });
  }
</script>