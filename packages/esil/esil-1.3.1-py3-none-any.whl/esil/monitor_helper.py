
import numpy as np
import pandas as pd
import requests
import json
from io import StringIO

def get_monitor_data_from_api(start_date, end_date, station_codes=None,selected_columns=None, rename_columns=None, df_sites_info=None,station_types=None,city_names=None, model_lat_lons=None):
    '''
    @description: 从API获取监测站点数据    
    @param {datetime} start_date: 开始日期
    @param {datetime} end_date: 结束日期
    @param {list} station_codes: 监测站点代码列表，默认为None, 即所有广东省站点; otherwise, using station_codes,e.g., station_codes=["440100051","440100057"]
    @param {list} selected_columns: 选择的列名, 默认为None,     
    即["timePoint","code","sO2","nO2","pM10","pM25","o3","co","o3_8H_Avg","temperature","humidity","airPress","windSpeed","windDirect"]
    otherwise, using selected_columns,e.g., selected_columns=["timePoint","code","sO2","nO2","o3","co","o3_8H_Avg"]
    @param {dict} rename_columns: 重命名列名, 默认为None, 
    即{"timePoint":"TimePoint","code":"StationCode","sO2":"SO2","nO2":"NO2","pM10":"PM10","pM25":"PM25","o3":"O3","co":"CO","o3_8H_Avg":"O3_8H_average","temperature":"Temperature","humidity":"Humidity","airPress":"AirPress","windSpeed":"WindSpeed","windDirect":"WindDirection"}
    otherwise, using rename_columns,e.g., rename_columns={"timePoint":"TimePoint","code":"StationCode","sO2":"SO2","nO2":"NO2","o3":"O3","co":"CO","o3_8H_Avg":"O3_8H_average"}
    @param {dataframe} df_sites_info: 监测站点信息数据, 默认为None;if not None, using df_sites_info to add columns to result dataframe,
    including "StationCode","StationName","AreaCode","AreaName","StationTypeName","Longitude","Latitude","Longitude_GD","Latitude_GD","Longitude_BD","Latitude_BD","DistrictCode","Address","HasUse"
    "Longitude","Latitude":WGS84坐标系
    "Longitude_BD","Latitude_BD":百度坐标系
    "Longitude_GD","Latitude_GD":高德坐标系
    df_sites_info example:
    StationCode	StationName	AreaCode	AreaName	StationTypeName	Longitude	Latitude	Longitude_GD	Latitude_GD	Longitude_BD	Latitude_BD	DistrictCode	Address	HasUse
    440100001	帽峰山森林公园	440100	广州	省控	113.443	23.3035	113.4484911	23.30102873	113.4550662	23.30675192			1
    440100051	广雅中学	440100	广州	国控	113.2347	23.1422	113.240028	23.13952884	113.2465454	23.1453559			1
    440100057	市监测站	440100	广州	国控	113.2597	23.1331	113.2650271	23.13042278	113.2714584	23.13665939			1
    @param {list} station_types: 站点类型,默认为None, 即所有站点类型; otherwise, using station_types, e.g., station_types=["国控"] 或 station_types=["省控"] 或  station_types=["国控","省控"]
    @param {list} city_names: 城市名称列表, 默认为None, 即所有城市; otherwise, using city_names, e.g., city_names=["广州","深圳","佛山"]
    @param {tuple} model_lat_lons: 模型所有网格中心点经纬度坐标, 默认为None, 即不计算当前测点落在哪个网格。如果提供该参数(lats,lons)，则计算当前测点落在哪个网格，并添加到row_index,col_index,grid_index列中。
    @return {dataframe} result: 监测站点数据
    '''
    # 设置连接路径与头参数  
    url = f'https://hycx-gd.cn/forecast/api/AqiGuangDong/Hour/GetHourData?IsSK=true&DataType=station&CalcRegionAqiType=0&StartDateTime={start_date.strftime("%Y-%m-%d %H:%M:%S")}&EndDateTime={end_date.strftime("%Y-%m-%d %H:%M:%S")}'  # &Codes=440100051&Codes=440100057'
    if station_codes is None:
        station_codes = get_station_codes()
    url=f"{url}&Codes={'&Codes='.join(map(str,station_codes))}"
    header = {
        "access-token": "tjK912423m8I57pFSjr",
        "Content-Type": "application/json;charset=utf-8",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/117.0",
    }
    # 连接网站并获取数据
    response = requests.get(url=url, headers=header)
    if response.status_code != 200:
        print("请求失败")
        return None
    response_data = json.loads(response.content)
    result = pd.DataFrame(response_data)   
 
    selected_columns=["timePoint","code","sO2","nO2","pM10","pM25","o3","co","o3_8H_Avg","temperature","humidity","airPress","windSpeed","windDirect"] if selected_columns is None else selected_columns
    dict_rename_columns = {
        "timePoint": "TimePoint",
        "code": "StationCode",
        "sO2": "SO2",
        "nO2": "NO2",
        "pM10": "PM10",
        "pM25": "PM25",
        "o3": "O3",
        "co": "CO",
        "o3_8H_Avg": "O3_8H_average",
        "temperature": "Temperature",
        "humidity": "Humidity",
        "airPress": "AirPress",
        "windSpeed": "WindSpeed",
        "windDirect": "WindDirection",
    }  if rename_columns is None else rename_columns 
        
    result = result[selected_columns]   
    # df[selected_columns].rename(columns=new_column_names)
    result = result.rename(columns=dict_rename_columns)
    result["StationCode"] = result["StationCode"].astype(str)    
    if df_sites_info is None:
        df_sites_info=get_guangdong_sites_info(model_lat_lons=model_lat_lons)
    if df_sites_info is not None:
        result = pd.merge(result, df_sites_info, left_on="StationCode", right_on="StationCode", how="left")
        if station_types is not None:
            result = result[result["StationTypeName"].isin(station_types)]
        if city_names is not None:
            result = result[result["AreaName"].isin(city_names)]
        
    # 将 -9999 替换为 NaN
    # result.replace(-9999, np.nan, inplace=True)
    # 替换 -9999 和 -9999.0 为 NaN
    result.replace([-9999, -9999.0], np.nan, inplace=True)    
    # result = result.where(result >= 0, np.nan)    
    return result

def get_guangdong_sites_info(monitor_site_file=None,model_lat_lons=None):
    '''
    @description: 获取广东省监测站点信息
    @param {str} monitor_site_file: 监测站点信息文件路径, 默认为None, 即从内置的字符串中解析获取，否则从文件中读取
    @return {dataframe} df_sites_info: 监测站点信息数据
    示例：
    StationCode	StationName	AreaCode	AreaName	StationTypeName	Longitude	Latitude	Longitude_GD	Latitude_GD	Longitude_BD	Latitude_BD	DistrictCode	Address	HasUse
    440100001	帽峰山森林公园	440100	广州	省控	113.443	23.3035	113.4484911	23.30102873	113.4550662	23.30675192			1
    440100051	广雅中学	440100	广州	国控	113.2347	23.1422	113.240028	23.13952884	113.2465454	23.1453559			1
    '''    
    if monitor_site_file is not None:
        df_sites_info = pd.read_csv(monitor_site_file)
    else:   
        #region 站点信息 
        str_sites_info='''
        StationCode	StationName	AreaCode	AreaName	StationTypeName	Longitude	Latitude	Longitude_GD	Latitude_GD	Longitude_BD	Latitude_BD	DistrictCode	Address	HasUse
        440100001	帽峰山森林公园	440100	广州	省控	113.443	23.3035	113.4484911	23.30102873	113.4550662	23.30675192			1
        440100051	广雅中学	440100	广州	国控	113.2347	23.1422	113.240028	23.13952884	113.2465454	23.1453559			1
        440100057	市监测站	440100	广州	国控	113.2597	23.1331	113.2650271	23.13042278	113.2714584	23.13665939			1
        440100063	麓湖	440100	广州	国控	113.2765	23.1544	113.2818421	23.15174258	113.2882648	23.15807917			1
        440100064	市五中	440100	广州	国控	113.2612	23.105	113.266526	23.10231195	113.2729709	23.10857015			1
        440100074	体育西	440100	广州	国控	113.3208	23.1323	113.3262154	23.12970164	113.3327479	23.13544244			1
        440100088	广东商学院	440100	广州	国控	113.3479	23.0916	113.353367	23.08903564	113.3599306	23.09477769			1
        440100089	市八十六中	440100	广州	国控	113.4332	23.105	113.4386959	23.10247454	113.4452239	23.10832437			1
        440100090	番禺中学	440100	广州	国控	113.3516	22.9477	113.357064	22.94508037	113.3636261	22.95087108			1
        440100091	花都师范	440100	广州	国控	113.2146	23.3917	113.2199621	23.38912116	113.2265217	23.39477932			1
        440100092	九龙镇镇龙	440100	广州	国控	113.5618	23.312	113.5669324	23.30922765	113.5735062	23.31496765			1
        440100920	白云嘉禾	440100	广州	国控	113.2981	23.237	113.3034788	23.2344003	113.3099421	23.24051137			1
        440100921	黄埔科学城	440100	广州	国控	113.4256	23.1716	113.4311116	23.16911023	113.4376246	23.17509227			1
        440100924	南沙街	440100	广州	国控	113.5342	22.7896	113.5393697	22.7866845	113.545821	22.79286192			1
        440103302	荔湾芳村	440100	广州	省控	113.235756	23.079976	113.2410793	23.07727877	113.2476287	23.0831295			1
        440105001R	南沙大稳	440100	广州	省控	113.42742	22.896035	113.4329104	22.89342797	113.4394015	22.89937243			1
        440105501	海珠湖	440100	广州	省控	113.327063	23.079261	113.3324876	23.07665269	113.33907	23.08234241			1
        440106604	天河五山	440100	广州	省控	113.364621	23.159499	113.3701207	23.15698864	113.3766171	23.16299016			1
        440111003	白云竹料	440100	广州	国控	113.3472	23.3692	113.3526847	23.36672497	113.3592206	23.37245322			1
        440112017	黄埔永和	440100	广州	省控	113.559674	23.205456	113.5648038	23.20265406	113.571368	23.20841879			1
        440113001	番禺大学城	440100	广州	国控	113.3942	23.0483	113.3997187	23.0457707	113.4061554	23.05211204			1
        440114001R	花都竹洞	440100	广州	省控	113.073112	23.420867	113.0786078	23.41844016	113.0851545	23.42429572			1
        440114403	花都梯面	440100	广州	国控	113.2902	23.5544	113.2955875	23.55183909	113.3020586	23.55807597			1
        440115001R	南沙科大	440100	广州	省控	113.617769	22.755893	113.6228212	22.75288799	113.6292665	22.75909756			1
        440115005	南沙黄阁	440100	广州	国控	113.4922	22.8168	113.4975138	22.81401534	113.5040007	22.8201485			1
        440117001R	从化天湖	440100	广州	省控	113.624443	23.650278	113.6295579	23.64751059	113.6360048	23.65380335			1
        440117004	从化良口	440100	广州	国控	113.7858	23.7478	113.7909962	23.74516089	113.7974862	23.75114023			1
        440117012	从化街口	440100	广州	国控	113.5717	23.5491	113.5768299	23.54634248	113.5834188	23.55201042			1
        440118001	增城荔城	440100	广州	国控	113.8051	23.2614	113.8102202	23.25871915	113.8167634	23.26441792			1
        440118002	增城派潭	440100	广州	省控	113.790235	23.496093	113.7954051	23.49347771	113.8019055	23.4993784			1
        440200052	市八中	440200	韶关	国控	113.5866	24.7695	113.5917941	24.76643825	113.5983674	24.7721632			1
        440200053	碧湖山庄（十三五）	440200	韶关	国控	113.5684	24.8101	113.5736218	24.80705855	113.5801728	24.81273244			0
        440200054	园林处	440200	韶关	国控	113.5981	24.7959	113.6032883	24.79283786	113.6098018	24.79871789			1
        440200055	韶关学院	440200	韶关	国控	113.6735	24.7791	113.6787565	24.77613105	113.6852933	24.78198097			1
        440200056	曲江监测站	440200	韶关	国控	113.5971	24.6864	113.6022811	24.68333091	113.6087919	24.6891929			1
        440200057	碧湖山庄	440200	韶关	国控	113.5684	24.8101	113.5736218	24.80705855	113.5801728	24.81273244			1
        440200066	武江白芒	440200	韶关	省控	113.578351	24.757123	113.5835536	24.75406593	113.5901456	24.75973522			1
        440200067	浈江十里亭	440200	韶关	省控	113.553278	24.829696	113.5585334	24.82668121	113.565053	24.83253126			1
        440222001	始兴丹凤	440200	韶关	省控	114.070703	24.959292	114.0759934	24.95660865	114.08254	24.96237882			1
        440224002	仁化丹霞	440200	韶关	省控	113.760437	25.087762	113.7657655	25.08492124	113.7721986	25.0912482			1
        440229001	翁源龙仙	440200	韶关	省控	114.143038	24.362844	114.1482099	24.3601503	114.1547032	24.36618238			1
        440232001	乳源乳城	440200	韶关	省控	113.284707	24.775104	113.290172	24.77224442	113.2966157	24.7785389			1
        440233001	新丰丰城	440200	韶关	省控	114.232013	24.064879	114.2369526	24.06215565	114.2433791	24.06849354			1
        440281001	乐昌乐城	440200	韶关	省控	113.348424	25.135305	113.3540369	25.13259864	113.3606002	25.138348			1
        440282001	南雄雄州	440200	韶关	省控	114.314717	25.123573	114.319749	25.12081213	114.326304	25.12664039			1
        440300051	通心岭子站	440300	深圳	国控	114.1063	22.5545	114.111417	22.55181822	114.1178479	22.55812495			1
        440300052	洪湖	440300	深圳	国控	114.117	22.5625	114.1221034	22.55981285	114.1285359	22.5661531			1
        440300054	华侨城	440300	深圳	国控	113.987	22.5417	113.991962	22.53879351	113.9983827	22.54510217			1
        440300055	南海子站	440300	深圳	国控	113.9181	22.5171	113.9229584	22.5140512	113.9294876	22.5198341			1
        440300057	盐田	440300	深圳	国控	114.263	22.5908	114.2678214	22.58794254	114.2743332	22.59398542			1
        440300058	龙岗	440300	深圳	国控	114.24	22.7267	114.2448427	22.72386976	114.2512913	22.73020446			1
        440300059	西乡（十三五）	440300	深圳	国控	113.8953	22.5861	113.9001736	22.58305174	113.9066586	22.58922353			0
        440300060	梅沙	440300	深圳	国控	114.297	22.5978	114.3018407	22.59497956	114.3084271	22.60064199			1
        440300061	葵涌	440300	深圳	国控	114.41	22.6342	114.4149427	22.63153119	114.4214971	22.63719771			1
        440300062	观澜	440300	深圳	国控	114.085	22.75	114.0901425	22.74735529	114.0966346	22.75335638			1
        440300063	南澳	440300	深圳	国控	114.494	22.5422	114.4987268	22.53935431	114.5051718	22.54554208			1
        440300064	西乡	440300	深圳	国控	113.8953	22.5861	113.9001736	22.58305174	113.9066586	22.58922353			1
        440300914	莲花	440300	深圳	国控	114.0731	22.559	114.0782277	22.55630605	114.084763	22.56210746			1
        440300915	民治	440300	深圳	国控	114.0261	22.6198	114.0311632	22.61701848	114.0376704	22.62299826			1
        440300916	坪山	440300	深圳	国控	114.3551	22.7151	114.3600294	22.71240857	114.3664807	22.71875552			1
        440300917	横岗	440300	深圳	国控	114.1871	22.6451	114.1920404	22.64231358	114.1985772	22.64803328			1
        44030607B	新湖街道	440300	深圳	省控	113.9631	22.7775	113.9680235	22.77457677	113.9745115	22.78053764			1
        440306601	宝安福永	440300	深圳	省控	113.822617	22.675631	113.8276533	22.67269868	113.8342087	22.67838279			1
        440310805	坪山田心山	440300	深圳	省控	114.377922	22.667722	114.3828698	22.66504907	114.3893311	22.67117149			1
        440400052	吉大	440400	珠海	国控	113.574	22.2611	113.5790423	22.25808997	113.585611	22.26375005			1
        440400053	前山	440400	珠海	国控	113.495	22.2294	113.5002654	22.22658675	113.5067506	22.23276487			1
        440400054	唐家	440400	珠海	国控	113.628	22.4251	113.6330376	22.42206442	113.6394589	22.42837979			1
        440400055	斗门	440400	珠海	国控	113.299	22.2281	113.3043134	22.22531287	113.3108129	22.23141632			1
        440400902	金湾	440400	珠海	国控	113.3547	22.0544	113.3601099	22.05178187	113.3666231	22.05760972			1
        440404901	横琴	440400	珠海	国控	113.5433	22.1163	113.5483997	22.11339384	113.5549135	22.11942611			1
        440404902	金湾红旗	440400	珠海	省控	113.352517	22.144812	113.357929	22.14215197	113.3644661	22.14795063			1
        440404903	高栏南水	440400	珠海	省控	113.249112	22.030726	113.2543639	22.02797541	113.2608409	22.03405082			1
        440500051	金平子站	440500	汕头	国控	116.6794	23.3667	116.6838627	23.36404074	116.6903906	23.36980465			1
        440500052	龙湖子站	440500	汕头	国控	116.7244	23.3633	116.7289513	23.36070833	116.7354378	23.36668564			1
        440500054	濠江子站	440500	汕头	国控	116.7258	23.2775	116.7303476	23.27488791	116.7368411	23.28089325			1
        440500055	澄海子站	440500	汕头	国控	116.7519	23.4714	116.7564818	23.46883593	116.7629039	23.47517851			1
        440500056	潮阳子站	440500	汕头	国控	116.6092	23.2539	116.6135256	23.25110802	116.6199932	23.25716833			1
        440500057	潮南子站（十三五）	440500	汕头	国控	116.4069	23.2533	116.4116055	23.25087374	116.4180286	23.25715654			0
        440500062	潮南子站	440500	汕头	国控	116.4069	23.2533	116.4116055	23.25087374	116.4180286	23.25715654			1
        440500915	潮南峡山	440500	汕头	国控	116.454	23.2684	116.458642	23.26592009	116.4651984	23.27156896			1
        440523058	南澳后宅	440500	汕头	省控	117.018611	23.428056	117.0233766	23.42554512	117.0298718	23.43166827			1
        440600401	湾梁	440600	佛山	国控	113.134	23.0048	113.1394689	23.0022253	113.1459181	23.00838311			1
        440600402	华材职中	440600	佛山	国控	113.105	23.0395	113.1104915	23.03696498	113.1170474	23.04267495			1
        440600404	南海气象局	440600	佛山	国控	113.144	23.0467	113.1494579	23.04412864	113.1559032	23.05041853			1
        440600405	顺德苏岗	440600	佛山	国控	113.292	22.8054	113.2973397	22.80261787	113.3038003	22.80882758			1
        440600406	容桂街道办（十三五）	440600	佛山	国控	113.2544	22.7642	113.2597006	22.76137242	113.2661497	22.76753413			0
        440600407	高明孔堂	440600	佛山	国控	112.844	22.8693	112.8490714	22.86638289	112.8556226	22.87209697			1
        440600408	三水监测站	440600	佛山	国控	112.885	23.1572	112.8900428	23.15434842	112.8965369	23.16034801			1
        440600409	三水云东海	440600	佛山	国控	112.863	23.1886	112.8680641	23.18578412	112.8746466	23.19147918			1
        440600423	顺德伦教	440600	佛山	省控	113.20812	22.881781	113.2134562	22.87902708	113.2200044	22.88470385			1
        440600455	容桂街道办	440600	佛山	国控	113.2544	22.7642	113.2597006	22.76137242	113.2661497	22.76753413			1
        440604446	禅城同济	440600	佛山市	省控	113.119616	23.0221	113.1251	23.019549					0
        440605415	南海西樵	440600	佛山	省控	112.9689	22.9504	112.9740515	22.94755134	112.9806365	22.95323267			1
        440605418	南海狮山	440600	佛山市	省控	112.989113	23.17846	112.994347	23.175764					0
        440606410	佛山新城	440600	佛山	省控	113.12795	22.976474	113.1334239	22.97389465	113.1399177	22.97995642			1
        440607303	三水南山	440600	佛山	省控	112.880875	23.530838	112.8859443	23.52806924	112.8924672	23.53399954			1
        440608301	高明杨和	440600	佛山	省控	112.800431	22.818963	112.8055723	22.81610605	112.8120214	22.82243313			1
        440700001	东湖	440700	江门	国控	113.0828	22.5947	113.0882517	22.59201165	113.0948266	22.59773848			1
        44070051	北街	440700	江门	国控	113.1064	22.6058	113.1118621	22.60311697	113.1184324	22.60884404			1
        44070053	西区	440700	江门	国控	113.0731	22.5835	113.0785391	22.58080146	113.0850858	22.58665826			1
        44070054	圭峰西	440700	江门	国控	113.0219	22.5311	113.0272067	22.52828987	113.0336342	22.53455179			1
        440704001	江海富民	440700	江门	国控	113.1075	22.5647	113.1129592	22.56201154	113.1195139	22.56774778			1
        440704003	江海中沙	440700	江门	省控	113.101454	22.580285	113.1069146	22.57759985	113.1134936	22.58328564			1
        440705001	新会银湖	440700	江门	国控	113.0486	22.4656	113.0539819	22.46285643	113.06045	22.46911232			1
        440781001	台山上朗	440700	江门	省控	112.80873	22.250069	112.8138223	22.24717106	112.8202845	22.25342708			1
        440781001R	台山端芬	440700	江门	省控	112.607	22.0608	112.6119003	22.05784791	112.6184426	22.06353648			1
        440783303	开平卫民	440700	江门	省控	112.713362	22.382749	112.7184742	22.37985448	112.7250032	22.38570935			1
        440784001	鹤山南山	440700	江门	省控	112.969881	22.763923	112.9750235	22.76100549	112.981572	22.76667448			1
        440784001R	鹤山花果山	440700	江门	省控	112.932823	22.716942	112.9378684	22.71393343	112.9443472	22.72013833			1
        440784002R	鹤山双桥	440700	江门	省控	112.588413	22.592692	112.5933437	22.58963624	112.5998751	22.59558134			1
        440785001	恩平东华	440700	江门	省控	112.323589	22.18877	112.3287784	22.18603327	112.3352057	22.19233269			1
        440800051	湛江影剧院	440800	湛江	国控	110.3539	21.2706	110.3583857	21.26820928	110.3649417	21.2740239			1
        440800052	市环境监测站	440800	湛江	国控	110.3928	21.2228	110.397339	21.22045253	110.4037592	21.22677729			1
        440800053	环保局宿舍	440800	湛江	国控	110.4019	21.1997	110.4064425	21.19735429	110.412867	21.20366387			1
        440800054	霞山游泳场	440800	湛江	国控	110.4111	21.2028	110.4156437	21.20045256	110.422083	21.20667545			1
        440800055	坡头区环保局	440800	湛江	国控	110.4558	21.2567	110.4602969	21.25429117	110.466874	21.2599624			1
        440800056	麻章区环保局	440800	湛江	国控	110.3316	21.2679	110.3360374	21.26546904	110.3426189	21.27114881			1
        440800060	东南子站	440800	湛江	省控	110.5128	20.9247	110.5171318	20.92212218	110.5235856	20.92845299			1
        440800061	东山子站	440800	湛江	省控	110.39	21.0305	110.3945263	21.02814529	110.4009853	21.03446669			1
        440800062	海大	440800	湛江	省控	110.3035	21.1534	110.3078705	21.15091683	110.314383	21.15695741			1
        440800063	石头村	440800	湛江	省控	110.3952	21.1627	110.3997373	21.16035254	110.4061907	21.16668693			1
        440823001	遂溪建设	440800	湛江	省控	110.247778	21.382778	110.2520992	21.38023789	110.2586093	21.38627749			1
        440825001	徐闻东方路	440800	湛江	省控	110.198618	20.342398	110.2029279	20.34006222	110.209466	20.34585512			1
        440825001R	徐闻海安	440800	湛江	省控	110.314666	20.521388	110.319026	20.51898387	110.3255529	20.52483302			1
        440881001	廉江新兴	440800	湛江	省控	110.296686	21.613355	110.3010684	21.61080379	110.3075497	21.61695502			1
        440882001	雷州朝南	440800	湛江	省控	110.105929	20.913124	110.1104113	20.91076625	110.1169846	20.91648752			1
        440883001	吴川梅岭	440800	湛江	省控	110.786367	21.447128	110.7909137	21.44455802	110.7973979	21.45053847			1
        440900001	电白南海	440900	茂名	国控	111.0286	21.4688	111.0334623	21.46633506	111.039961	21.47227251			1
        440900401	茂石化七小	440900	茂名	国控	110.9294	21.6533	110.9339197	21.65053219	110.9404907	21.65621793			1
        440900402	健康路	440900	茂名	国控	110.9107	21.6687	110.9151887	21.66591147	110.9217002	21.67182101			1
        440900403	高岭	440900	茂名	国控	110.8592	21.6828	110.8636834	21.68004007	110.8701237	21.68625517			1
        440904001	电白水东	440900	茂名	国控	111.01	21.5165	111.0147925	21.51397168	111.0212656	21.52021345			1
        440981001	高州教育	440900	茂名	省控	110.86338	21.919196	110.8678735	21.91632623	110.8743058	21.92259108			1
        440981002	高州红荔	440900	茂名	省控	110.837736	21.899266	110.8422538	21.8964487	110.8487834	21.90231821			1
        440982001	化州博龙	440900	茂名	省控	110.662698	21.64168	110.6670737	21.63897142	110.6735813	21.64502552			1
        440983001	信宜新尚	440900	茂名	省控	110.940261	22.35912	110.9448471	22.35608845	110.9514306	22.36177003			1
        440983002	信宜六谢	440900	茂名	省控	110.935868	22.349098	110.9404422	22.34606127	110.9470285	22.3517324			1
        441200001	七星岩子站	441200	肇庆	省控	112.4753	23.1	112.4805294	23.09737416	112.4870683	23.10319796			1
        441200401	睦岗子站	441200	肇庆	国控	112.4267	23.0706	112.4320338	23.06806058	112.43849	23.07437295			1
        441200402	城中子站	441200	肇庆	国控	112.4645	23.0475	112.4697565	23.04488059	112.4762606	23.0508859			1
        441200404	坑口子站	441200	肇庆	国控	112.5544	23.1522	112.5594051	23.14937985	112.5658253	23.15571523			1
        441201001	高新知青	441200	肇庆	省控	112.818562	23.309117	112.823706	23.30641798	112.8302026	23.31253149			1
        441203004	鼎湖凤凰	441200	肇庆	国控	112.5617	23.2083	112.5666957	23.20548802	112.5731438	23.21180796			1
        441204001	高要湖西	441200	肇庆	国控	112.4575	23.0166	112.4627726	23.01398416	112.4692279	23.02010489			1
        441223001	广宁庄前西	441200	肇庆	省控	112.43656	23.638817	112.4419177	23.63637123	112.4483435	23.64270608			1
        441224001	怀集三江口	441200	肇庆	省控	112.173061	23.925704	112.1783918	23.92310701	112.1848764	23.9292534			1
        441224002	怀集文昌	441200	肇庆	省控	112.211805	23.919729	112.2170574	23.91706901	112.2235307	23.92328397			1
        441225001	封开府前	441200	肇庆	省控	111.515576	23.425061	111.5207364	23.4224042	111.5272919	23.42822966			1
        441226001	德庆香山	441200	肇庆	省控	112.151735	23.77163	112.1571021	23.76912584	112.1636556	23.7749174			1
        441284001	四会城中	441200	肇庆	省控	112.699183	23.342963	112.7043316	23.34030255	112.7108108	23.34640137			1
        441300401	江北云山西路子站	441300	惠州	国控	114.4103	23.1142	114.4152736	23.11170597	114.4218296	23.1173709			1
        441300402	惠阳区承修路船湖子站	441300	惠州	国控	114.4645	22.7833	114.4693417	22.78058852	114.475767	22.78687651			1
        441300403	大亚湾管委会子站	441300	惠州	国控	114.5317	22.7422	114.5363101	22.73928298	114.5428778	22.74494591			1
        441300751	下埔横江三路子站	441300	惠州	国控	114.4053	23.0822	114.4102751	23.07969389	114.4168527	23.08539766			1
        441300752	河南岸金山湖子站	441300	惠州	国控	114.4183	23.0528	114.4232615	23.05027582	114.4298396	23.05593956			1
        441300914	惠阳秋长	441300	惠州	国控	114.4338	22.8134	114.4387216	22.81076032	114.4452702	22.81657125			1
        441300915	大亚湾霞涌	441300	惠州	国控	114.6517	22.775	114.6562466	22.77205412	114.6627941	22.7777129			1
        441302001	仲恺陈江	441300	惠州	省控	114.325313	23.013941	114.3302187	23.01130892	114.3366984	23.01730891			1
        441303001R	惠阳金果湾	441300	惠州	省控	114.380604	22.939805	114.3855708	22.9372281	114.3920704	22.94331005			1
        441322001R	博罗石下	441300	惠州	省控	114.02976	23.21158	114.0348701	23.20902299	114.0413983	23.21493886			1
        441322005	博罗罗阳	441300	惠州	省控	114.293803	23.174541	114.2986773	23.1719203	114.3052581	23.17758054			1
        441323004	惠东莲花地	441300	惠州	省控	114.737797	22.99122	114.7424915	22.98848933	114.7489566	22.99461951			1
        441324002	龙门县龙城	441300	惠州	省控	114.250945	23.736634	114.2558444	23.73402493	114.2622772	23.74025238			1
        441400001	梅江月梅	441400	梅州	国控	116.1278	24.3289	116.1326204	24.32625435	116.1390912	24.33229798			1
        441400404	梅县新城	441400	梅州	国控	116.0797	24.2719	116.0845463	24.26928296	116.0911161	24.27504672			1
        441400405	环境监控中心	441400	梅州	国控	116.1248	24.2654	116.1296208	24.26277815	116.1361404	24.26877503			1
        441400914	梅龙	441400	梅州	国控	116.1233	24.2991	116.1281253	24.29646844	116.1346361	24.30243505			1
        441422404	大埔湖寮	441400	梅州	省控	116.411486	24.210664	116.4162538	24.20807735	116.4226864	24.21430352			1
        441423001R	丰顺八乡山	441400	梅州	省控	115.5754	23.462	115.5799929	23.45925197	115.5864585	23.46542561			1
        441423404	丰顺汤坑	441400	梅州	省控	116.1057	23.4433	116.1104871	23.44091237	116.1170636	23.44661858			1
        441424404	五华水寨	441400	梅州	省控	115.465181	23.55473	115.4700927	23.55225699	115.4766125	23.55825928			1
        441426404	平远大道	441400	梅州	省控	115.533932	24.334994	115.5386733	24.33207694	115.5451218	24.3382249			1
        441427404	蕉岭镇山	441400	梅州	省控	116.10794	24.394411	116.1127897	24.3917635	116.1193666	24.39749449			1
        441481404	兴宁南坛	441400	梅州	省控	115.435232	24.81406	115.4402992	24.81136255	115.4467053	24.81770464			1
        441500401	市环保局	441500	汕尾	国控	115.3653	22.775	115.3702274	22.77234941	115.3767675	22.77804378			1
        441500402	市政府	441500	汕尾	国控	115.3706	22.7898	115.3755358	22.78716129	115.3820901	22.79282216			1
        441500403	新城中学	441500	汕尾	国控	115.3622	22.7925	115.3671238	22.78985094	115.3736673	22.7955786			1
        441521001	海丰牛黄山	441500	汕尾	省控	115.324567	22.972396	115.3294297	22.96975202	115.3358791	22.97605868			1
        441523001	陆河河田	441500	汕尾	省控	115.40912	23.1819	115.4141018	23.17944064	115.4206036	23.18551778			1
        441581001	陆丰迎仙桥	441500	汕尾	省控	115.644099	22.944338	115.6486746	22.94145233	115.655197	22.94743178			1
        441600001	源西	441600	河源	省控	114.6778	23.7569	114.6824589	23.754206	114.6889805	23.76007244			1
        441600401	东埔	441600	河源	国控	114.6944	23.7586	114.6990907	23.7559358	114.7055539	23.76209261			1
        441600403	老城	441600	河源	国控	114.6892	23.7233	114.6938788	23.72063565	114.7003472	23.72670148			1
        441602001	埔前	441600	河源	省控	113.6216666	23.5741666	113.6267746	23.57140465	113.6332287	23.57766878			1
        441602004	永安	441600	河源	省控									1
        441621401	紫金紫城	441600	河源	省控	115.195303	23.644268	115.2001584	23.64173654	115.2065892	23.64808249			1
        441622001	龙川同德	441600	河源	省控	115.263852	24.103725	115.2686943	24.10099163	115.2752428	24.10667761			1
        441622002	龙川老隆	441600	河源	省控	115.283371	24.111183	115.2882338	24.10846347	115.2947294	24.11442921			1
        441623401	连平东园	441600	河源	省控	114.492777	24.366944	114.4976266	24.36412799	114.5040867	24.37033618			1
        441623402	连平连中	441600	河源	省控	114.473055	24.375277	114.4779741	24.37251564	114.4844133	24.37885969			1
        441624001	和平新华	441600	河源	省控	114.939138	24.407083	114.9437766	24.40408442	114.9502427	24.41031522			1
        441624002	和平南堤	441600	河源	省控	114.7389	23.7506	114.743644	23.74798898	114.7501092	23.75409906			1
        441625001	东源东江	441600	河源	省控	114.74	23.786111	114.7447468	23.78349044	114.7512458	23.78958776			1
        441700001	鸳鸯湖	441700	阳江	省控	111.9797	21.8593	111.9847682	21.85656126	111.9912655	21.86265506			1
        441700402	马南垌	441700	阳江	国控	111.9491	21.8658	111.9540919	21.86298185	111.9605478	21.86930534			1
        441700403	南恩路	441700	阳江市	国控	111.9508	21.8536	111.955795	21.850791					0
        441700404	阳春城东	441700	阳江	省控	111.804279	22.177671	111.8093969	22.17479822	111.81588	22.18078386			1
        441700914	两阳中学	441700	阳江	国控	111.977	21.893	111.9820626	21.8902378	111.9885457	21.89637531			1
        441721001	阳西城区	441700	阳江	省控	111.613483	21.756039	111.6184224	21.75322398	111.6249045	21.75941854			1
        441723001	阳东陶然	441700	阳江	国控	112.0125	21.8749	112.0176683	21.87225202	112.024253	21.87792228			1
        441723006	海陵闸坡	441700	阳江	省控	111.921389	21.651667	111.9263286	21.64889769	111.9328518	21.65483563			1
        441800001	环保大楼	441800	清远	省控	113.0425	23.6936	113.0479484	23.69110909	113.0543922	23.69742112			1
        441800401	凤城街办	441800	清远	国控	113.0208	23.7106	113.026182	23.70804872	113.0326207	23.71430118			1
        441800403	技师学院	441800	清远	国控	113.0472	23.6344	113.052657	23.63192977	113.0590931	23.63819546			1
        441800914	清新太和	441800	清远	国控	112.9903	23.7403	112.9955763	23.73765043	113.002107	23.74341429			1
        441800915	清城东城	441800	清远	国控	113.076	23.7198	113.0815205	23.71735994	113.0880454	23.72316425			1
        441802006	清城银盏	441800	清远	省控	113.146471	23.559154	113.1519601	23.55670316	113.158414	23.56301681			1
        441821052	佛冈沿江	441800	清远	省控	113.5238	23.8825	113.5290761	23.87976864	113.5355122	23.88607144			1
        441823001	阳山城南	441800	清远	省控	112.634114	24.465417	112.6391998	24.4623816	112.6457235	24.46819715			1
        441823002	阳山城北	441800	清远	省控	112.642972	24.477909	112.6480744	24.47488453	112.6545767	24.48084939			1
        441825001	连山金山	441800	清远	省控	112.086345	24.572729	112.0918348	24.5700166	112.0982552	24.57628607			1
        441825002	连山广德	441800	清远	省控	112.105194	24.572861	112.1106823	24.57015062	112.1171654	24.57613433			1
        441826001	连南城西	441800	清远	省控	112.295012	24.719772	112.3003181	24.71691364	112.3067768	24.72308624			1
        441826002	连南城东	441800	清远	省控	112.282027	24.728972	112.2873165	24.72609685	112.293833	24.73205102			1
        441881003	英德城南	441800	清远	省控	113.41942	24.174395	113.4250089	24.17179196	113.4314983	24.17788162			1
        441882001	连州城西	441800	清远	省控	112.365836	24.782297	112.3712752	24.77956672	112.3778423	24.78526428			1
        441882002	连州城东	441800	清远	省控	112.391601	24.7929	112.3970658	24.79019481	112.4036025	24.79598132			1
        441900401	南城元岭（十三五）	441900	东莞	国控	113.7533	23.0202	113.758492	23.01747707	113.764905	23.02381362			0
        441900402	莞城梨川	441900	东莞	国控	113.7547	23.0494	113.7598929	23.04668945	113.7663305	23.05303209			1
        441900403	东城主山（十三五）	441900	东莞	国控	113.7875	23.0457	113.7926458	23.04296301	113.7991583	23.04891649			0
        441900404	东城石井	441900	东莞	国控	113.7944	23.0128	113.7995289	23.01003929	113.8060424	23.01587197			1
        441900405	南城西平	441900	东莞	国控	113.7383	22.9658	113.7434944	22.96305109	113.7499649	22.96927569			1
        441900407	南城元岭	441900	东莞	国控	113.7532938	23.02024478	113.7584857	23.01752187	113.7648988	23.02385842			1
        441900408	东城主山	441900	东莞	国控	113.787471	23.0457429	113.7926168	23.04300597	113.7991293	23.04895996			1
        441900409	东莞松山湖	441900	东莞	省控	113.881944	22.925278	113.8868565	22.92233867	113.8932945	22.92865903			1
        441900412	东莞塘厦	441900	东莞	省控	114.068611	22.808889	114.0737524	22.8062483	114.0803101	22.81199229			1
        441900415	东莞常平	441900	东莞	省控	114.009167	22.974167	114.0142128	22.97145394	114.0206706	22.97770727			1
        441900439	东莞麻涌	441900	东莞	省控	113.563611	23.046944	113.5687223	23.04407235	113.5752838	23.04979018			1
        441900914	万江金泰	441900	东莞	国控	113.7338	23.0381	113.7389992	23.03537991	113.7454632	23.04153386			1
        442000001	中山小榄	442000	中山	省控	113.272734	22.652147	113.2780387	22.64929917	113.2844515	22.6556333			1
        442000002	中山三乡	442000	中山	省控	113.449719	22.354424	113.455131	22.35169884	113.4617154	22.35737332			1
        442000003	中山民众	442000	中山	省控	113.504609	22.630912	113.5098671	22.62803818	113.5163005	22.6343303			1
        442000005	中山南朗	442000	中山	省控	113.528044	22.497919	113.5332139	22.49496483	113.539667	22.50122812			1
        442000010	长江旅游区	442000	中山	省控	113.4411	22.4853	113.4465396	22.48257846	113.4531065	22.48832228			1
        442000051	华柏园	442000	中山	国控	113.3769	22.5211	113.3823717	22.51839937	113.3888148	22.52460142			1
        442000052	张溪	442000	中山	国控	113.3881	22.5497	113.3935824	22.54701006	113.4000062	22.55332877			1
        442000053	紫马岭	442000	中山	国控	113.4075	22.5111	113.4129817	22.50841174	113.4194208	22.5146747			1
        442000915	中山南区	442000	中山	国控	113.3536	22.4777	113.3590359	22.47496721	113.3655915	22.48078629			1
        445100001	西园路	445100	潮州	省控	116.6339	23.6714	116.6382833	23.66866485	116.6447321	23.67501731			1
        445100402	档案局	445100	潮州	国控	116.6447	23.6706	116.6491035	23.66788112	116.6555599	23.67419601			1
        445100404	市政府	445100	潮州	国控	116.6183	23.6589	116.6226599	23.65614967	116.6291309	23.66236795			1
        445102001	潮安庵北	445100	潮州	省控	116.671944	23.467778	116.6763956	23.46511885	116.6829136	23.47100276			1
        445122456	饶平城北	445100	潮州	省控	117.0075	23.686944	117.0122418	23.68439108	117.0186992	23.69067533			1
        445200401	新兴	445200	揭阳	国控	116.3701	23.5345	116.374805	23.53209968	116.3812991	23.53818893			1
        445200402	东兴	445200	揭阳	国控	116.3611	23.5626	116.3657946	23.56018666	116.3723269	23.56611383			1
        445200403	西马	445200	揭阳	国控	116.3264	23.5443	116.3310317	23.54182566	116.3376125	23.54751805			1
        445200404	渔湖	445200	揭阳	国控	116.4151	23.5294	116.4198198	23.52701699	116.426291	23.53319589			1
        445203053	产业园龙尾	445200	揭阳	省控	116.152645	23.580922	116.1573659	23.57848358	116.1637974	23.58482906			1
        445203054	曲溪	445200	揭阳	国控	116.403	23.5699	116.4077272	23.56751957	116.4141741	23.57384301			1
        445222001	揭西河婆	445200	揭阳	省控	115.861473	23.451721	115.8659957	23.44899531	115.8725733	23.45466686			1
        445224001	惠来惠城	445200	揭阳	省控	116.289722	23.036388	116.2942596	23.03371987	116.3007025	23.03997469			1
        445281001	普宁城北	445200	揭阳	省控	116.158694	23.30725	116.163383	23.30477196	116.1698331	23.31111879			1
        445281002	普宁城东	445200	揭阳	省控	116.181666	23.293333	116.1862998	23.29080807	116.1927969	23.29687728			1
        445300001	新市府	445300	云浮	省控	112.0392	22.9169	112.0445083	22.91423069	112.0510219	22.92013417			1
        445300401	文笔（十三五）	445300	云浮	国控	112.0336	22.9374	112.0388956	22.93472528	112.045447	22.94054348			0
        445300403	牧羊	445300	云浮	国控	112.0539	22.9539	112.0592424	22.95127828	112.0657299	22.95743869			1
        445300404	文笔	445300	云浮	国控	112.0336	22.9374	112.0388956	22.93472528	112.045447	22.94054348			1
        445302001	云安都杨	445300	云浮	省控	112.159956	23.044739	112.1652571	23.0421316	112.1717763	23.04804934			1
        445321801	新兴南外	445300	云浮	省控	112.234114	22.694085	112.2392593	22.69123428	112.2458019	22.69707955			1
        445322001	郁南城西	445300	云浮	省控	111.537261	23.232962	111.5423523	23.23020085	111.5489115	23.23586668			1
        445381001R	罗定罗光	445300	云浮	省控	111.342222	22.578889	111.3474266	22.57612678	111.3538877	22.58239398			1
        445381002	罗定兴华	445300	云浮	省控	111.594533	22.761743	111.5995245	22.75871697	111.6059399	22.76504835			1
        445381223	罗定沿江	445300	云浮	省控	111.571671	22.782158	111.5766745	22.77915365	111.5831337	22.78526472			1
        '''
        #endregion
        # 使用 StringIO 将字符串读入为文件对象
        data = StringIO(str_sites_info)
        # 解析为 DataFrame
        df_sites_info = pd.read_csv(data, sep='\t')
        # 去除列名的前后空格
        df_sites_info.columns = df_sites_info.columns.str.strip()
        # 去除 `StationCode` 列中每个值的前后空格
        df_sites_info['StationCode'] = df_sites_info['StationCode'].astype(str).str.strip()
        if model_lat_lons is not None:
            model_lats, model_lons=model_lat_lons
            df_sites_info, _, _=get_monitor_grid_index(df_sites_info,model_lats,model_lons,monitor_lat_name='Latitude',monitor_lon_name='Longitude')
    return df_sites_info

def get_station_codes(monitor_site_file=None,city_names=None,station_types=None):
    """
    从广东所有站点中，获取指定城市的站点代码
    @param {list} city_names: 城市名称列表,不带“市”字，如["广州","深圳"]
    @param {list} station_types: 站点类型列表，如["国控","省控"]
    @return {list} 站点代码列表
    """
    df_sites_info = get_guangdong_sites_info(monitor_site_file=monitor_site_file)
    if city_names is not None:
        df_sites_info = df_sites_info[df_sites_info['AreaName'].isin(city_names)]
    if station_types is not None:
        df_sites_info = df_sites_info[df_sites_info['StationType'].isin(station_types)]
    station_codes = df_sites_info['StationCode'].tolist()
    return station_codes

def get_monitor_grid_index(df_monitors, model_lats, model_lons, monitor_lat_name='纬度', monitor_lon_name='经度'):
    '''
    @description: 获取每个站点所在的网格索引，行索引和列索引
    @param {dataframe} df_monitors: 监测站点数据
    @param {array(2D)} model_lats: 模型数据纬度
    @param {array(2D)} model_lons: 模型数据经度
    @param {str} monitor_lat_name: 监测站点纬度字段名
    @param {str} monitor_lon_name: 监测站点经度字段名
    @return {dataframe} df_monitors: 包含网格索引，行索引和列索引的监测站点数据  
    '''
    from scipy.spatial import cKDTree
    from tqdm.auto import tqdm  # 显示进度

    num_grid_points_lon = len(model_lats[0, :])
    # 创建KD树以快速查询最近邻
    tree = cKDTree(np.vstack([model_lons.ravel(), model_lats.ravel()]).T)
    # 创建一个空列表用于存储计算结果
    rows, cols, gridindexs = [], [], []
    for index, row_index in tqdm(df_monitors.iterrows(), desc="计算监测站点所在的网格索引"):
        point = np.array([row_index[monitor_lon_name], row_index[monitor_lat_name]])
        # 使用KD树查询最近的网格点       
        _, index = tree.query(point)
        gridindexs.append(index)
        # 计算所在的列索引和行索引
        col_index = index % num_grid_points_lon
        row_index = index // num_grid_points_lon
        rows.append(row_index)
        cols.append(col_index)
    df_monitors["grid_index"] = gridindexs
    df_monitors["row_index"] = rows
    df_monitors["col_index"] = cols
    return df_monitors, "row_index", "col_index"

if __name__ == '__main__':
    # 读取监测站点信息
    df_sites_info = pd.read_csv("/DeepLearning/mnt/Devin/data/monitors/T_Station.csv")
    # df_sites_info.to_csv("/DeepLearning/mnt/Devin/data/monitors/T_Station.csv", index=False, encoding="utf-8-sig")
    df=get_guangdong_sites_info()    
    start_date = pd.to_datetime("2022-01-01 00:00:00")
    end_date = pd.to_datetime("2022-01-01 23:59:59")    
    station_codes = [440100051, 440100057]
    df_monitors = get_monitor_data_from_api(start_date,end_date,station_codes=station_codes,df_sites_info=df_sites_info)
    df_monitors1 = get_monitor_data_from_api(start_date,end_date)
    prd_cities=["广州","深圳","珠海","佛山","江门","肇庆","惠州","东莞","中山"]
    prd_stations_codes=get_station_codes(city_names=prd_cities)
    df_monitors2= get_monitor_data_from_api(start_date,end_date,station_codes=prd_stations_codes)
    df_monitors3= get_monitor_data_from_api(start_date,end_date,city_names=prd_cities)
    print(df_monitors)
    print("done")